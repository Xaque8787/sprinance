{% extends "base.html" %}

{% block title %}{{ employee.name }} - Tip Report{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div>
            <a href="/reports/tip-report" class="breadcrumb">← Back to Tip Reports</a>
            <h1>{{ employee.name }} - {{ employee.position.name }}</h1>
        </div>
        <button type="button" class="btn btn-primary" onclick="openExportModal()">
            Export Report
        </button>
    </div>

    <div class="filter-section">
        <div class="month-navigation">
            <a href="/reports/tip-report/employee/{{ employee.slug }}?month={{ prev_month.strftime('%Y-%m') }}" class="btn btn-secondary">
                ← {{ prev_month.strftime('%B %Y') }}
            </a>
            <h2>{{ current_month.strftime('%B %Y') }}</h2>
            <a href="/reports/tip-report/employee/{{ employee.slug }}?month={{ next_month.strftime('%Y-%m') }}" class="btn btn-secondary">
                {{ next_month.strftime('%B %Y') }} →
            </a>
        </div>

        <div class="custom-date-filter">
            <h3>Or filter by custom date range:</h3>
            <form method="GET" action="/reports/tip-report/employee/{{ employee.slug }}" class="date-range-form">
                <div class="form-group">
                    <label for="start_date">Start Date</label>
                    <input type="date" id="start_date" name="start_date" value="{{ start_date }}" class="form-control">
                </div>
                <div class="form-group">
                    <label for="end_date">End Date</label>
                    <input type="date" id="end_date" name="end_date" value="{{ end_date }}" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">Apply</button>
                {% if is_custom_range %}
                <a href="/reports/tip-report/employee/{{ employee.slug }}" class="btn btn-secondary">Clear</a>
                {% endif %}
            </form>
        </div>
    </div>

    <div class="summary-cards">
        <div class="summary-card">
            <h3>Total Bank Card Tips</h3>
            <p class="summary-value">${{ "%.2f"|format(total_bank_card_tips) }}</p>
        </div>
        <div class="summary-card">
            <h3>Total Cash Tips</h3>
            <p class="summary-value">${{ "%.2f"|format(total_cash_tips) }}</p>
        </div>
        <div class="summary-card">
            <h3>Total Adjustments</h3>
            <p class="summary-value">${{ "%.2f"|format(total_adjustments) }}</p>
        </div>
        <div class="summary-card highlight">
            <h3>Total Take Home</h3>
            <p class="summary-value">${{ "%.2f"|format(total_take_home) }}</p>
        </div>
    </div>

    {% if entries %}
    <div class="entries-list">
        <h3>Daily Entries ({{ start_date }} to {{ end_date }})</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Day</th>
                    <th>Bank Card Sales</th>
                    <th>Bank Card Tips</th>
                    <th>Total Sales</th>
                    <th>Cash Tips</th>
                    <th>Adjustments</th>
                    <th>Take Home</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr>
                    <td>{{ entry.daily_balance.date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ entry.daily_balance.date.strftime('%A') }}</td>
                    <td>${{ "%.2f"|format(entry.bank_card_sales or 0) }}</td>
                    <td>${{ "%.2f"|format(entry.bank_card_tips or 0) }}</td>
                    <td>${{ "%.2f"|format(entry.total_sales or 0) }}</td>
                    <td>${{ "%.2f"|format(entry.cash_tips or 0) }}</td>
                    <td>${{ "%.2f"|format(entry.adjustments or 0) }}</td>
                    <td class="highlight-cell">${{ "%.2f"|format(entry.calculated_take_home or 0) }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="totals-row">
                    <td colspan="3"><strong>Totals</strong></td>
                    <td><strong>${{ "%.2f"|format(total_bank_card_tips) }}</strong></td>
                    <td></td>
                    <td><strong>${{ "%.2f"|format(total_cash_tips) }}</strong></td>
                    <td><strong>${{ "%.2f"|format(total_adjustments) }}</strong></td>
                    <td class="highlight-cell"><strong>${{ "%.2f"|format(total_take_home) }}</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>No entries found for this date range</p>
    </div>
    {% endif %}
</div>

<div id="export-modal" class="modal">
    <div class="modal-content">
        <h3>Export {{ employee.name }}'s Tip Report</h3>
        <p>Select a date range to export a tip report for {{ employee.name }}.</p>

        <div class="export-options">
            <div class="form-group">
                <label>
                    <input type="radio" name="export_type" value="month" checked onchange="toggleExportType()">
                    Export by Month
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="radio" name="export_type" value="custom" onchange="toggleExportType()">
                    Custom Date Range
                </label>
            </div>
        </div>

        <div id="month-selector" class="date-selector">
            <div class="form-group">
                <label for="export_month">Select Month</label>
                <input type="month" id="export_month" class="form-control" value="{{ current_month.strftime('%Y-%m') }}">
            </div>
        </div>

        <div id="custom-selector" class="date-selector" style="display: none;">
            <div class="form-row">
                <div class="form-group">
                    <label for="export_start_date">Start Date</label>
                    <input type="date" id="export_start_date" class="form-control">
                </div>
                <div class="form-group">
                    <label for="export_end_date">End Date</label>
                    <input type="date" id="export_end_date" class="form-control">
                </div>
            </div>
        </div>

        <div class="form-group" style="margin-top: 1.5rem;">
            <label>
                <input type="checkbox" id="export_download_copy">
                <strong>Download local copy</strong>
            </label>
        </div>

        <div class="form-group" style="margin-top: 1rem;">
            <label>
                <input type="checkbox" id="export_send_email" onchange="toggleExportEmailSection()">
                <strong>Send via email</strong>
            </label>
        </div>

        <div id="export_email_section" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
            <div id="email_loading" style="display: none; margin-bottom: 1rem;">
                Loading admin users...
            </div>

            <div id="email_content" style="display: none;">
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Select Recipients:</label>
                    <div id="admin_users_list" style="max-height: 150px; overflow-y: auto; margin-bottom: 1rem;"></div>
                </div>

                <div class="form-group">
                    <label for="export_additional_email" style="font-weight: 600;">Additional Email (Optional):</label>
                    <input type="email" id="export_additional_email" class="form-control" placeholder="email@example.com">
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
            <button class="btn btn-primary" onclick="exportReport()">Export CSV</button>
        </div>
    </div>
</div>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
}

.page-header > div {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.breadcrumb {
    color: #3498db;
    text-decoration: none;
    font-size: 0.9rem;
}

.breadcrumb:hover {
    text-decoration: underline;
}

.filter-section {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.month-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e9ecef;
}

.month-navigation h2 {
    margin: 0;
    font-size: 1.5rem;
}

.custom-date-filter h3 {
    font-size: 1rem;
    margin-bottom: 1rem;
    color: #495057;
}

.date-range-form {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
}

.date-range-form .form-group {
    flex: 1;
    max-width: 200px;
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.summary-card {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    text-align: center;
}

.summary-card.highlight {
    background: #e3f2fd;
    border: 2px solid #3498db;
}

.summary-card h3 {
    font-size: 0.9rem;
    margin: 0 0 0.5rem 0;
    color: #6c757d;
    font-weight: 500;
}

.summary-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #2c3e50;
    margin: 0;
}

.entries-list {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.entries-list h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: #2c3e50;
}

.table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.table thead {
    background: #f8f9fa;
}

.table th,
.table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.table th {
    font-weight: 600;
    color: #495057;
    font-size: 0.875rem;
}

.table tbody tr:hover {
    background: #f8f9fa;
}

.table tfoot {
    background: #f8f9fa;
    font-weight: bold;
}

.totals-row {
    border-top: 2px solid #495057;
}

.highlight-cell {
    background: #e3f2fd;
    font-weight: 600;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-top: 2rem;
}

.empty-state p {
    color: #6c757d;
    font-size: 1.1rem;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
}

.modal.active {
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    padding: 2rem;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-content h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: #2c3e50;
}

.export-options {
    margin: 1.5rem 0;
}

.export-options label {
    display: block;
    margin-bottom: 0.5rem;
    cursor: pointer;
}

.export-options input[type="radio"] {
    margin-right: 0.5rem;
}

.date-selector {
    margin: 1.5rem 0;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 2rem;
}
</style>

<script>
function openExportModal() {
    const modal = document.getElementById('export-modal');
    modal.classList.add('active');
}

function closeExportModal() {
    const modal = document.getElementById('export-modal');
    modal.classList.remove('active');
}

function toggleExportType() {
    const exportType = document.querySelector('input[name="export_type"]:checked').value;
    const monthSelector = document.getElementById('month-selector');
    const customSelector = document.getElementById('custom-selector');

    if (exportType === 'month') {
        monthSelector.style.display = 'block';
        customSelector.style.display = 'none';
    } else {
        monthSelector.style.display = 'none';
        customSelector.style.display = 'block';
    }
}

async function toggleExportEmailSection() {
    const sendEmailChecked = document.getElementById('export_send_email').checked;
    const emailSection = document.getElementById('export_email_section');
    const emailLoading = document.getElementById('email_loading');
    const emailContent = document.getElementById('email_content');

    if (sendEmailChecked) {
        emailSection.style.display = 'block';
        emailLoading.style.display = 'block';
        emailContent.style.display = 'none';

        try {
            const response = await fetch('/reports/admin-users?report_type=tips');
            const data = await response.json();

            if (data.success) {
                const usersList = document.getElementById('admin_users_list');
                usersList.innerHTML = '';

                data.users.forEach(user => {
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.style.marginBottom = '0.5rem';
                    label.style.cursor = 'pointer';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'user_emails';
                    checkbox.value = user.email;
                    checkbox.checked = user.opt_in;
                    checkbox.style.marginRight = '0.5rem';

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(`${user.username} (${user.email})`));

                    usersList.appendChild(label);
                });

                emailLoading.style.display = 'none';
                emailContent.style.display = 'block';
            }
        } catch (error) {
            emailSection.innerHTML = '<p style="color: red;">Error loading admin users. Please try again.</p>';
        }
    } else {
        emailSection.style.display = 'none';
    }
}

async function exportReport() {
    const exportType = document.querySelector('input[name="export_type"]:checked').value;
    const employeeSlug = '{{ employee.slug }}';
    const downloadCopy = document.getElementById('export_download_copy').checked;
    const sendEmail = document.getElementById('export_send_email').checked;

    if (!downloadCopy && !sendEmail) {
        alert('Please select at least one option: Download local copy or Send via email');
        return;
    }

    let startDate, endDate;

    if (exportType === 'month') {
        const monthValue = document.getElementById('export_month').value;
        if (!monthValue) {
            alert('Please select a month');
            return;
        }

        const [year, month] = monthValue.split('-');
        startDate = `${year}-${month}-01`;

        const lastDay = new Date(year, month, 0).getDate();
        endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
    } else {
        startDate = document.getElementById('export_start_date').value;
        endDate = document.getElementById('export_end_date').value;

        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }

        if (new Date(startDate) > new Date(endDate)) {
            alert('Start date must be before end date');
            return;
        }
    }

    // Handle download
    if (downloadCopy) {
        window.location.href = `/reports/tip-report/employee/${employeeSlug}/export?start_date=${startDate}&end_date=${endDate}`;
    }

    // Handle email
    if (sendEmail) {
        const checkboxes = document.querySelectorAll('input[name="user_emails"]:checked');
        const userEmails = Array.from(checkboxes).map(cb => cb.value);
        const additionalEmail = document.getElementById('export_additional_email').value.trim();

        if (userEmails.length === 0 && !additionalEmail) {
            alert('Please select at least one recipient or enter an email address');
            return;
        }

        const formData = new FormData();
        formData.append('start_date', startDate);
        formData.append('end_date', endDate);

        userEmails.forEach(email => {
            formData.append('user_emails[]', email);
        });

        if (additionalEmail) {
            formData.append('additional_email', additionalEmail);
        }

        try {
            const response = await fetch(`/reports/tip-report/employee/${employeeSlug}/email`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                alert('Report sent successfully!');
            } else {
                alert('Error sending report: ' + result.message);
            }
        } catch (error) {
            alert('Error sending report. Please try again.');
        }
    }

    closeExportModal();
}

window.onclick = function(event) {
    const modal = document.getElementById('export-modal');
    if (event.target === modal) {
        closeExportModal();
    }
}
</script>
{% endblock %}
