{% extends "base.html" %}

{% block title %}Positions & Tip Requirements{% endblock %}

{% block content %}
<div class="container">
    <div class="header-section">
        <h1>Position & Tip Management</h1>
    </div>

    <div class="content-section">
        <div class="section-header">
            <h2>Positions</h2>
            <a href="/positions/new" class="btn btn-primary">Add New Position</a>
        </div>

        {% if positions %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Position Name</th>
                        <th>Tip Entry Requirements</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for position in positions %}
                    <tr>
                        <td><strong>{{ position.name }}</strong></td>
                        <td>
                            {% if position.tip_requirements %}
                                {% for req in position.tip_requirements %}
                                    <span class="badge">{{ req.name }}</span>
                                {% endfor %}
                            {% else %}
                                <em>No requirements</em>
                            {% endif %}
                        </td>
                        <td class="actions">
                            <a href="/positions/{{ position.slug }}/edit" class="btn btn-sm">Edit</a>
                            <form action="/positions/{{ position.slug }}/delete" method="post" style="display: inline;" onsubmit="return confirm('Delete this position? Employees using this position will need to be reassigned.');">
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="empty-state">No positions found. Add your first position above.</p>
        {% endif %}
    </div>

    <div class="content-section" style="margin-top: 2rem;">
        <div class="section-header">
            <h2>Tip Entry Requirements</h2>
            <button onclick="document.getElementById('newTipModal').style.display='block'" class="btn btn-primary">Add New Requirement</button>
        </div>

        {% if tip_requirements %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Requirement Name</th>
                        <th>Field Name</th>
                        <th>Display Order</th>
                        <th>Attributes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in tip_requirements %}
                    <tr>
                        <td><strong>{{ req.name }}</strong></td>
                        <td><code>{{ req.field_name }}</code></td>
                        <td>{{ req.display_order }}</td>
                        <td>
                            {% if req.is_total %}
                                <span class="badge badge-info">Total</span>
                            {% endif %}
                            {% if req.is_deduction %}
                                <span class="badge badge-warning">Deduction</span>
                            {% endif %}
                            {% if req.no_input %}
                                <span class="badge badge-secondary">No Input</span>
                            {% endif %}
                            {% if req.no_null_value %}
                                <span class="badge badge-danger">Required</span>
                            {% endif %}
                            {% if req.apply_to_revenue %}
                                <span class="badge badge-success">→ Revenue {% if req.revenue_is_deduction %}(−){% else %}(+){% endif %}</span>
                            {% endif %}
                            {% if req.apply_to_expense %}
                                <span class="badge badge-success">→ Expense {% if req.expense_is_deduction %}(−){% else %}(+){% endif %}</span>
                            {% endif %}
                        </td>
                        <td class="actions">
                            <button onclick="openEditModal('{{ req.slug }}', '{{ req.name }}', '{{ req.field_name }}', {{ req.display_order }})" class="btn btn-sm">Edit</button>
                            <form action="/tip-requirements/{{ req.slug }}/delete" method="post" style="display: inline;" onsubmit="return confirm('Delete this requirement? It will be removed from all positions.');">
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="empty-state">No tip requirements found.</p>
        {% endif %}
    </div>
</div>

<div id="newTipModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="document.getElementById('newTipModal').style.display='none'">&times;</span>
        <h2>Add New Tip Requirement</h2>
        <form action="/tip-requirements/new" method="post">
            <div class="form-group">
                <label for="name">Requirement Name:</label>
                <input type="text" id="name" name="name" required>
                <small>Field name will be auto-generated from this name</small>
            </div>
            <div class="form-group">
                <label for="display_order">Display Order:</label>
                <input type="number" id="display_order" name="display_order" value="0" min="0">
                <small>Lower numbers appear first in forms</small>
            </div>

            <div class="form-group" style="border-top: 1px solid #e0e0e0; padding-top: 1rem; margin-top: 1rem;">
                <strong style="display: block; margin-bottom: 0.5rem;">Behavior Options:</strong>

                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="is_total" name="is_total" value="true">
                    <span>Is Total - This is a calculated total field (not editable, auto-calculated)</span>
                </label>

                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="is_deduction" name="is_deduction" value="true">
                    <span>Is Deduction - Subtract from the total field</span>
                </label>

                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="no_input" name="no_input" value="true">
                    <span>No Input - Display name only (placeholder/memo, no input field)</span>
                </label>

                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem; cursor: pointer;">
                    <input type="checkbox" id="no_null_value" name="no_null_value" value="true">
                    <span>Require Value - Must have a positive value above 0</span>
                </label>
            </div>

            <div class="form-group" style="border-top: 1px solid #e0e0e0; padding-top: 1rem;">
                <strong style="display: block; margin-bottom: 0.5rem;">Apply to Financial Tables:</strong>

                <div style="margin-bottom: 1rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="apply_to_revenue" name="apply_to_revenue" value="true" onchange="toggleRevenueOptions(this.checked)">
                        <span><strong>Apply to Revenue & Income</strong></span>
                    </label>
                    <div id="revenue_options" style="margin-left: 2rem; display: none;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" id="revenue_addition" name="revenue_type" value="addition" checked>
                            <span>As Addition</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" id="revenue_deduction" name="revenue_type" value="deduction">
                            <span>As Deduction</span>
                        </label>
                    </div>
                </div>

                <div style="padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="apply_to_expense" name="apply_to_expense" value="true" onchange="toggleExpenseOptions(this.checked)">
                        <span><strong>Apply to Deposits & Expenses</strong></span>
                    </label>
                    <div id="expense_options" style="margin-left: 2rem; display: none;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" id="expense_addition" name="expense_type" value="addition" checked>
                            <span>As Addition</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" id="expense_deduction" name="expense_type" value="deduction">
                            <span>As Deduction</span>
                        </label>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Create Requirement</button>
        </form>
    </div>
</div>

<div id="editTipModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="document.getElementById('editTipModal').style.display='none'">&times;</span>
        <h2>Edit Tip Requirement</h2>
        <form id="editTipForm" method="post">
            <div class="form-group">
                <label for="edit_name">Requirement Name:</label>
                <input type="text" id="edit_name" name="name" required>
                <small>Field name will be auto-generated from this name</small>
            </div>
            <div class="form-group">
                <label for="edit_display_order">Display Order:</label>
                <input type="number" id="edit_display_order" name="display_order" value="0" min="0">
                <small>Lower numbers appear first in forms</small>
            </div>

            <div class="form-group" style="border-top: 1px solid #e0e0e0; padding-top: 1rem; margin-top: 1rem;">
                <strong style="display: block; margin-bottom: 0.5rem;">Behavior Options:</strong>

                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="edit_is_total" name="is_total" value="true">
                    <span>Is Total - This is a calculated total field (not editable, auto-calculated)</span>
                </label>

                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="edit_is_deduction" name="is_deduction" value="true">
                    <span>Is Deduction - Subtract from the total field</span>
                </label>

                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="edit_no_input" name="no_input" value="true">
                    <span>No Input - Display name only (placeholder/memo, no input field)</span>
                </label>

                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem; cursor: pointer;">
                    <input type="checkbox" id="edit_no_null_value" name="no_null_value" value="true">
                    <span>Require Value - Must have a positive value above 0</span>
                </label>
            </div>

            <div class="form-group" style="border-top: 1px solid #e0e0e0; padding-top: 1rem;">
                <strong style="display: block; margin-bottom: 0.5rem;">Apply to Financial Tables:</strong>

                <div style="margin-bottom: 1rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="edit_apply_to_revenue" name="apply_to_revenue" value="true" onchange="toggleEditRevenueOptions(this.checked)">
                        <span><strong>Apply to Revenue & Income</strong></span>
                    </label>
                    <div id="edit_revenue_options" style="margin-left: 2rem; display: none;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" id="edit_revenue_addition" name="revenue_type" value="addition" checked>
                            <span>As Addition</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" id="edit_revenue_deduction" name="revenue_type" value="deduction">
                            <span>As Deduction</span>
                        </label>
                    </div>
                </div>

                <div style="padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="edit_apply_to_expense" name="apply_to_expense" value="true" onchange="toggleEditExpenseOptions(this.checked)">
                        <span><strong>Apply to Deposits & Expenses</strong></span>
                    </label>
                    <div id="edit_expense_options" style="margin-left: 2rem; display: none;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" id="edit_expense_addition" name="expense_type" value="addition" checked>
                            <span>As Addition</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" id="edit_expense_deduction" name="expense_type" value="deduction">
                            <span>As Deduction</span>
                        </label>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Update Requirement</button>
        </form>
    </div>
</div>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 2rem;
    border: 1px solid #888;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: #000;
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    margin: 0.25rem;
    background: #e3f2fd;
    border-radius: 4px;
    font-size: 0.875rem;
}

.badge-info {
    background: #e3f2fd;
    color: #1976d2;
}

.badge-warning {
    background: #fff3e0;
    color: #f57c00;
}

.badge-secondary {
    background: #f5f5f5;
    color: #616161;
}

.badge-danger {
    background: #ffebee;
    color: #c62828;
}

.badge-success {
    background: #e8f5e9;
    color: #2e7d32;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.empty-state {
    text-align: center;
    color: #666;
    padding: 2rem;
}
</style>

<script>
function toggleRevenueOptions(checked) {
    document.getElementById('revenue_options').style.display = checked ? 'block' : 'none';
}

function toggleExpenseOptions(checked) {
    document.getElementById('expense_options').style.display = checked ? 'block' : 'none';
}

function toggleEditRevenueOptions(checked) {
    document.getElementById('edit_revenue_options').style.display = checked ? 'block' : 'none';
}

function toggleEditExpenseOptions(checked) {
    document.getElementById('edit_expense_options').style.display = checked ? 'block' : 'none';
}

async function openEditModal(slug, name, fieldName, displayOrder) {
    // Fetch the full requirement data
    const response = await fetch('/tip-requirements/' + slug + '/data');
    const req = await response.json();

    document.getElementById('edit_name').value = req.name;
    document.getElementById('edit_display_order').value = req.display_order;

    document.getElementById('edit_is_total').checked = req.is_total || false;
    document.getElementById('edit_is_deduction').checked = req.is_deduction || false;
    document.getElementById('edit_no_input').checked = req.no_input || false;
    document.getElementById('edit_no_null_value').checked = req.no_null_value || false;

    document.getElementById('edit_apply_to_revenue').checked = req.apply_to_revenue || false;
    toggleEditRevenueOptions(req.apply_to_revenue || false);
    if (req.revenue_is_deduction) {
        document.getElementById('edit_revenue_deduction').checked = true;
    } else {
        document.getElementById('edit_revenue_addition').checked = true;
    }

    document.getElementById('edit_apply_to_expense').checked = req.apply_to_expense || false;
    toggleEditExpenseOptions(req.apply_to_expense || false);
    if (req.expense_is_deduction) {
        document.getElementById('edit_expense_deduction').checked = true;
    } else {
        document.getElementById('edit_expense_addition').checked = true;
    }

    document.getElementById('editTipForm').action = '/tip-requirements/' + slug + '/update';
    document.getElementById('editTipModal').style.display = 'block';
}

window.onclick = function(event) {
    const newModal = document.getElementById('newTipModal');
    const editModal = document.getElementById('editTipModal');
    if (event.target == newModal) {
        newModal.style.display = 'none';
    }
    if (event.target == editModal) {
        editModal.style.display = 'none';
    }
}
</script>
{% endblock %}
