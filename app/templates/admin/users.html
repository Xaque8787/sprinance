{% extends "base.html" %}

{% block title %}Administration - Management System{% endblock %}

{% block content %}
<script>
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('restored') === 'true') {
    alert('✅ Database restored successfully!\n\nThe database has been replaced with the backup. The page will reload now.');
    window.location.href = '/admin';
}
if (urlParams.get('settings_updated') === 'true') {
    alert('✅ Settings updated successfully!');
    window.location.href = '/admin';
}
</script>

<div class="page-header">
    <h2>User Management</h2>
    <a href="/admin/users/new" class="btn btn-primary">Create New User</a>
</div>

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Admin</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.username }}</td>
                <td>{{ user.email if user.email else '-' }}</td>
                <td>{% if user.is_admin %}Yes{% else %}No{% endif %}</td>
                <td>
                    <a href="/admin/users/{{ user.slug }}/edit" class="btn btn-small">Edit</a>
                    {% if user.id != current_user.id %}
                    <form method="POST" action="/admin/users/{{ user.slug }}/delete" style="display: inline;">
                        <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('Are you sure you want to delete this user?')">Delete</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="page-header" style="margin-top: 3rem;">
    <h2>System Tools</h2>
</div>

<div class="settings-container">
    <div class="setting-item">
        <div class="setting-info">
            <h3>Checks & EFT Management</h3>
            <p>Manage checks and EFT transactions for daily balance reports.</p>
        </div>
        <a href="/checks-efts/manage" class="btn btn-primary">Manage Checks & EFT</a>
    </div>
</div>

<div class="page-header" style="margin-top: 3rem;">
    <h2>Backup Settings</h2>
</div>

<div class="settings-container">
    <div class="setting-item">
        <div class="setting-info">
            <h3>Backup Retention</h3>
            <p>Number of database backups to keep. Older backups will be automatically deleted.</p>
        </div>
        <form method="POST" action="/admin/settings/backup-retention" class="setting-form">
            <input type="number" name="retention_count" value="{{ backup_retention_count }}" min="1" max="100" class="form-control" style="width: 100px;">
            <button type="submit" class="btn btn-primary">Update</button>
        </form>
    </div>
</div>

<div class="page-header" style="margin-top: 3rem;">
    <h2>Database Backups</h2>
    <form method="POST" action="/admin/backups/create" style="display: inline;">
        <button type="submit" class="btn btn-primary" onclick="return confirm('Are you sure you want to create a backup?')">Create Backup</button>
    </form>
</div>

<div class="table-container">
    {% if backups %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Filename</th>
                <th>Size</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for backup in backups %}
            <tr>
                <td>{{ backup.filename }}</td>
                <td>{{ "%.2f"|format(backup.size / 1024) }} KB</td>
                <td>{{ backup.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>
                    <a href="/admin/backups/{{ backup.filename }}/download" class="btn btn-small">Download</a>
                    <form method="POST" action="/admin/backups/{{ backup.filename }}/restore" style="display: inline;">
                        <button type="submit" class="btn btn-small btn-warning" onclick="return confirm('⚠️ WARNING: This will replace your current database with this backup.\n\nAll current data will be lost and replaced with the backup data.\n\nThis action cannot be undone.\n\nAre you absolutely sure you want to restore this backup?')">Restore</button>
                    </form>
                    <form method="POST" action="/admin/backups/{{ backup.filename }}/delete" style="display: inline;">
                        <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('Are you sure you want to delete this backup?')">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No backups available. Create your first backup above.</p>
    {% endif %}
</div>

<style>
.settings-container {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
}

.setting-info h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    color: #2c3e50;
}

.setting-info p {
    margin: 0;
    font-size: 0.9rem;
    color: #6c757d;
}

.setting-form {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.setting-form .form-control {
    padding: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 0.9rem;
}

.setting-form .btn {
    padding: 0.5rem 1rem;
}
</style>
{% endblock %}
