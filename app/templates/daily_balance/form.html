{% extends "base.html" %}

{% block title %}Daily Balance - {{ target_date }} - Management System{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Daily Balance</h2>
    <form method="GET" action="/daily-balance" style="display: inline-block;">
        <input type="date" name="selected_date" value="{{ target_date }}" onchange="this.form.submit()">
    </form>
</div>

<div class="daily-info">
    <h3>{{ target_date }} - {{ day_of_week }}</h3>
    {% if daily_balance and daily_balance.finalized %}
        {% if edit_mode %}
        <span class="badge badge-warning">Editing Finalized Report</span>
        {% else %}
        <span class="badge badge-success">Viewing Finalized Report</span>
        {% endif %}
    {% endif %}
</div>

{% if daily_balance and daily_balance.finalized %}
<div class="report-metadata">
    <h4>Report Information</h4>
    <div class="metadata-grid">
        {% if daily_balance.created_by_source == "scheduled_task" %}
        <div class="metadata-item">
            <span class="metadata-label">Created By:</span>
            <span class="metadata-value">Automated Scheduled Task</span>
        </div>
        {% elif daily_balance.created_by_user %}
        <div class="metadata-item">
            <span class="metadata-label">Created By:</span>
            <span class="metadata-value">{{ daily_balance.created_by_user.username }}</span>
        </div>
        {% endif %}

        {% if daily_balance.finalized_at %}
        <div class="metadata-item">
            <span class="metadata-label">Finalized At:</span>
            <span class="metadata-value">{{ daily_balance.finalized_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
        </div>
        {% endif %}

        {% if daily_balance.edited_by_user %}
        <div class="metadata-item">
            <span class="metadata-label">Last Edited By:</span>
            <span class="metadata-value">{{ daily_balance.edited_by_user.username }}</span>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if daily_balance and daily_balance.finalized and not edit_mode %}
<div class="view-mode-banner">
    <div class="banner-content">
        <span class="icon">üëÅÔ∏è</span>
        <span>You are viewing a finalized report in read-only mode.</span>
        <a href="/reports/daily-balance" class="btn btn-secondary btn-sm">Back to Reports</a>
    </div>
</div>
{% endif %}

{% if edit_mode %}
<div class="alert alert-warning">
    <strong>‚ö†Ô∏è Warning:</strong> You are editing a finalized report. Changes will overwrite the existing database entry and CSV file when saved.
</div>
{% endif %}

{% if error %}
<div class="alert alert-error">
    <strong>‚ùå Error:</strong> {{ error }}
</div>
{% endif %}

<form method="POST" action="{% if daily_balance and daily_balance.finalized %}/daily-balance/save{% else %}/daily-balance/save{% endif %}" id="dailyBalanceForm">
    <input type="hidden" name="target_date" value="{{ target_date }}">

    <div class="form-section">
        <h3>Daily Financial Summary</h3>

        <div class="financial-tables-container">
            <div class="financial-table">
                <div class="section-header">
                    <h4>Revenue & Income</h4>
                    {% if current_user.is_admin and not (daily_balance and daily_balance.finalized and not edit_mode) %}
                    <button type="button" class="btn btn-sm" id="manage-revenue-btn" onclick="toggleManagementMode('revenue')">
                        <span class="icon">‚öô</span> <span id="manage-revenue-text">Manage Items</span>
                    </button>
                    {% endif %}
                </div>
                <table class="summary-table" id="revenue-table">
                    <tbody>
                        {% for template in financial_templates %}
                            {% if template.category == 'revenue' %}
                        <tr data-template-id="{{ template.id }}" data-template-name="{{ template.name }}" data-is-deduction="{{ template.is_deduction|lower }}" data-is-starting-till="{{ template.is_starting_till|lower }}" data-is-ending-till="{{ template.is_ending_till|lower }}">
                            <td>
                                <span class="item-name-display" id="name-display-{{ template.id }}">
                                    {{ template.name }}
                                    {% if template.is_deduction %}
                                    <span style="color: #dc2626; font-weight: bold;" title="This item subtracts from the total"> (‚àí)</span>
                                    {% endif %}
                                    {% if template.is_starting_till %}
                                    <span style="color: #2563eb; font-weight: bold;" title="Auto-populated from previous day"> (‚ü≤)</span>
                                    {% endif %}
                                    {% if template.is_ending_till %}
                                    <span style="color: #059669; font-weight: bold;" title="Ending till for next day"> (‚§µ)</span>
                                    {% endif %}
                                </span>
                                <input type="text" class="item-name-edit" id="name-edit-{{ template.id }}" value="{{ template.name }}" style="display: none;">
                                {% if current_user.is_admin %}
                                <span class="item-management-controls" style="display: none;">
                                    <button type="button" class="btn-icon btn-edit-small" onclick="startEditItemName({{ template.id }})" id="edit-btn-{{ template.id }}" title="Rename item">
                                        <span class="icon">‚úé</span>
                                    </button>
                                    <button type="button" class="btn-icon btn-save-small" onclick="saveItemName({{ template.id }}, 'revenue')" id="save-btn-{{ template.id }}" style="display: none;" title="Save">
                                        <span class="icon">‚úì</span>
                                    </button>
                                    <button type="button" class="btn-icon btn-cancel-small" onclick="cancelEditItemName({{ template.id }})" id="cancel-btn-{{ template.id }}" style="display: none;" title="Cancel">
                                        <span class="icon">‚úó</span>
                                    </button>
                                    <button type="button" class="btn-icon btn-remove-small" onclick="deleteFinancialTemplate({{ template.id }}, 'revenue')" title="Remove item">
                                        <span class="icon">√ó</span>
                                    </button>
                                    <label style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;">
                                        <input type="checkbox" onchange="toggleDeduction({{ template.id }}, 'revenue', this.checked)" {% if template.is_deduction %}checked{% endif %} title="Mark as deduction">
                                        <span style="font-size: 12px;">Deduction</span>
                                    </label>
                                    <label style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;">
                                        <input type="checkbox" onchange="toggleStartingTill({{ template.id }}, 'revenue', this.checked)" {% if template.is_starting_till %}checked{% endif %} title="Auto-populate from previous day">
                                        <span style="font-size: 12px;">Starting Till</span>
                                    </label>
                                    <label style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;">
                                        <input type="checkbox" onchange="toggleEndingTill({{ template.id }}, 'revenue', this.checked)" {% if template.is_ending_till %}checked{% endif %} title="Ending till for next day">
                                        <span style="font-size: 12px;">Ending Till</span>
                                    </label>
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <input type="number" step="0.01"
                                       name="financial_item_{{ template.id }}"
                                       class="table1-field"
                                       value="{% if financial_line_items.get('revenue_' + template.id|string) %}{{ financial_line_items.get('revenue_' + template.id|string).value }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                            {% endif %}
                        {% endfor %}
                        {% if daily_balance %}
                            {% for item in daily_balance.financial_line_items %}
                                {% if item.is_employee_tip and item.category == 'revenue' %}
                        <tr data-employee-tip="{{ item.employee_id }}" class="employee-tip-row">
                            <td><label>{{ item.name }}</label></td>
                            <td>
                                <input type="number" step="0.01" readonly
                                       class="table1-field calculated-field"
                                       value="{{ item.value }}">
                            </td>
                        </tr>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        <tr class="total-row">
                            <td><strong>Total</strong></td>
                            <td>
                                <input type="number" step="0.01" id="table1_total" readonly class="total-field" value="0.00">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="financial-table">
                <div class="section-header">
                    <h4>Deposits & Expenses</h4>
                    {% if current_user.is_admin and not (daily_balance and daily_balance.finalized and not edit_mode) %}
                    <button type="button" class="btn btn-sm" id="manage-expense-btn" onclick="toggleManagementMode('expense')">
                        <span class="icon">‚öô</span> <span id="manage-expense-text">Manage Items</span>
                    </button>
                    {% endif %}
                </div>
                <table class="summary-table" id="expense-table">
                    <tbody>
                        {% for template in financial_templates %}
                            {% if template.category == 'expense' %}
                        <tr data-template-id="{{ template.id }}" data-template-name="{{ template.name }}" data-is-deduction="{{ template.is_deduction|lower }}" data-is-starting-till="{{ template.is_starting_till|lower }}" data-is-ending-till="{{ template.is_ending_till|lower }}">
                            <td>
                                <span class="item-name-display" id="name-display-{{ template.id }}">
                                    {{ template.name }}
                                    {% if template.is_deduction %}
                                    <span style="color: #dc2626; font-weight: bold;" title="This item subtracts from the total"> (‚àí)</span>
                                    {% endif %}
                                    {% if template.is_starting_till %}
                                    <span style="color: #2563eb; font-weight: bold;" title="Auto-populated from previous day"> (‚ü≤)</span>
                                    {% endif %}
                                    {% if template.is_ending_till %}
                                    <span style="color: #059669; font-weight: bold;" title="Ending till for next day"> (‚§µ)</span>
                                    {% endif %}
                                </span>
                                <input type="text" class="item-name-edit" id="name-edit-{{ template.id }}" value="{{ template.name }}" style="display: none;">
                                {% if current_user.is_admin %}
                                <span class="item-management-controls" style="display: none;">
                                    <button type="button" class="btn-icon btn-edit-small" onclick="startEditItemName({{ template.id }})" id="edit-btn-{{ template.id }}" title="Rename item">
                                        <span class="icon">‚úé</span>
                                    </button>
                                    <button type="button" class="btn-icon btn-save-small" onclick="saveItemName({{ template.id }}, 'expense')" id="save-btn-{{ template.id }}" style="display: none;" title="Save">
                                        <span class="icon">‚úì</span>
                                    </button>
                                    <button type="button" class="btn-icon btn-cancel-small" onclick="cancelEditItemName({{ template.id }})" id="cancel-btn-{{ template.id }}" style="display: none;" title="Cancel">
                                        <span class="icon">‚úó</span>
                                    </button>
                                    <button type="button" class="btn-icon btn-remove-small" onclick="deleteFinancialTemplate({{ template.id }}, 'expense')" title="Remove item">
                                        <span class="icon">√ó</span>
                                    </button>
                                    <label style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;">
                                        <input type="checkbox" onchange="toggleDeduction({{ template.id }}, 'expense', this.checked)" {% if template.is_deduction %}checked{% endif %} title="Mark as deduction">
                                        <span style="font-size: 12px;">Deduction</span>
                                    </label>
                                    <label style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;">
                                        <input type="checkbox" onchange="toggleStartingTill({{ template.id }}, 'expense', this.checked)" {% if template.is_starting_till %}checked{% endif %} title="Auto-populate from previous day">
                                        <span style="font-size: 12px;">Starting Till</span>
                                    </label>
                                    <label style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;">
                                        <input type="checkbox" onchange="toggleEndingTill({{ template.id }}, 'expense', this.checked)" {% if template.is_ending_till %}checked{% endif %} title="Ending till for next day">
                                        <span style="font-size: 12px;">Ending Till</span>
                                    </label>
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <input type="number" step="0.01"
                                       name="financial_item_{{ template.id }}"
                                       class="table2-field"
                                       value="{% if financial_line_items.get('expense_' + template.id|string) %}{{ financial_line_items.get('expense_' + template.id|string).value }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                            {% endif %}
                        {% endfor %}
                        <tr class="total-row">
                            <td><strong>Total</strong></td>
                            <td>
                                <input type="number" step="0.01" id="table2_total" readonly class="total-field" value="0.00">
                            </td>
                        </tr>
                        <tr class="highlight-row">
                            <td><strong>Cash Over/Under</strong></td>
                            <td>
                                <input type="number" step="0.01" id="cash_over_under" readonly class="total-field highlight-field" value="0.00">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="notes">Notes</label>
            <textarea id="notes" name="notes" rows="3"
                      {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>{% if daily_balance %}{{ daily_balance.notes }}{% endif %}</textarea>
        </div>
    </div>

    {% if current_user.is_admin %}
    <div id="manage-items-modal" class="add-employee-modal" style="display: none;">
        <div class="modal-content-inline">
            <h4 id="manage-items-title">Manage Financial Items</h4>
            <div class="form-group">
                <label for="new-item-name">Item Name</label>
                <input type="text" id="new-item-name" placeholder="e.g., Liquor Sales" class="form-control">
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="new-item-is-deduction">
                    <span>Mark as deduction (subtracts from total)</span>
                </label>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="new-item-is-starting-till">
                    <span>Starting Till (auto-populate from previous day)</span>
                </label>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="new-item-is-ending-till">
                    <span>Ending Till (used for next day's starting till)</span>
                </label>
            </div>
            <button type="button" class="btn btn-primary btn-sm" onclick="addFinancialTemplate()">Add Item</button>
            <button type="button" class="btn btn-secondary btn-sm" onclick="closeManageModal()">Close</button>
        </div>
    </div>
    {% endif %}

    <div class="form-section">
        <div class="section-header">
            <h3>Employee Entries</h3>
            {% if not (daily_balance and daily_balance.finalized and not edit_mode) %}
            <button type="button" class="btn btn-sm" onclick="toggleAddEmployeeModal()">
                <span class="icon">+</span> Add Employee
            </button>
            {% endif %}
        </div>

        {% if not (daily_balance and daily_balance.finalized and not edit_mode) %}
        <div id="add-employee-modal" class="add-employee-modal" style="display: none;">
            <div class="modal-content-inline">
                <h4>Add Employee</h4>
                <select id="employee-to-add" class="employee-add-select">
                    <option value="">Select an employee...</option>
                </select>
                <button type="button" class="btn btn-primary btn-sm" onclick="addSelectedEmployee()">Add</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleAddEmployeeModal()">Cancel</button>
            </div>
        </div>
        {% endif %}

        <div id="employee-entries">
            {% set current_position = namespace(name='') %}
            {% for emp in working_employees %}
                {% if emp.position.name != current_position.name %}
                    <div class="position-group-header" data-position-name="{{ emp.position.name }}">
                        <h5>{{ emp.position.name }}</h5>
                    </div>
                    {% set current_position.name = emp.position.name %}
                {% endif %}
            <div class="employee-entry" id="entry-{{ emp.combo_id }}" data-combo-id="{{ emp.combo_id }}" data-employee-id="{{ emp.id }}" data-position-id="{{ emp.position.id }}" data-position-name="{{ emp.position.name }}" data-display-name="{{ emp.display_name }}">
                <div class="employee-entry-header">
                    <h4>{{ emp.display_name }} - {{ emp.position.name }}</h4>
                    {% if not (daily_balance and daily_balance.finalized and not edit_mode) %}
                    <button type="button" class="btn-icon btn-remove" onclick="removeEmployee('{{ emp.combo_id }}')" title="Remove employee">
                        <span class="icon">‚àí</span>
                    </button>
                    {% endif %}
                </div>
                <input type="hidden" name="employee_ids" value="{{ emp.combo_id }}" class="employee-id-input">

                <div class="form-row">
                    {% for req in emp.position.tip_requirements %}
                        {% if not req.no_input or req.is_total %}
                        <div class="form-group">
                            <label>{{ req.name }}{% if req.no_null_value and not req.is_total %} <span style="color: #dc2626;">*</span>{% endif %}</label>
                            {% if req.is_total %}
                            <input type="number" step="0.01" readonly
                                   value="{% if employee_entries.get(emp.combo_id) and employee_entries.get(emp.combo_id).tip_values and employee_entries.get(emp.combo_id).tip_values.get(req.field_name) %}{{ employee_entries.get(emp.combo_id).tip_values.get(req.field_name) }}{% else %}0.00{% endif %}"
                                   class="calculated-field tip-total-field"
                                   data-combo-id="{{ emp.combo_id }}"
                                   data-field-name="{{ req.field_name }}">
                            {% else %}
                            <input type="number" step="0.01" name="tip_{{ req.field_name }}_{{ emp.combo_id }}"
                                   class="tip-input"
                                   data-combo-id="{{ emp.combo_id }}"
                                   data-field-name="{{ req.field_name }}"
                                   data-is-deduction="{{ req.is_deduction|lower }}"
                                   data-record-data="{{ req.record_data|lower }}"
                                   data-apply-to-revenue="{{ req.apply_to_revenue|lower }}"
                                   data-revenue-is-deduction="{{ req.revenue_is_deduction|lower }}"
                                   data-apply-to-expense="{{ req.apply_to_expense|lower }}"
                                   data-expense-is-deduction="{{ req.expense_is_deduction|lower }}"
                                   value="{% if employee_entries.get(emp.combo_id) and employee_entries.get(emp.combo_id).tip_values and employee_entries.get(emp.combo_id).tip_values.get(req.field_name) %}{{ employee_entries.get(emp.combo_id).tip_values.get(req.field_name) }}{% else %}0.00{% endif %}"
                                   {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            {% endif %}
                        </div>
                        {% elif req.no_input %}
                        <div class="form-group">
                            <div style="font-weight: bold; color: #666; padding: 0.5rem 0;">{{ req.name }}</div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    {% if not (daily_balance and daily_balance.finalized and not edit_mode) %}
    <div class="form-actions">
        <button type="submit" class="btn btn-secondary" formaction="/daily-balance/save" onclick="return validateFormBeforeSubmit(event, false)">Save Draft</button>
        <button type="button" class="btn btn-primary" onclick="validateAndOpenFinalizeModal()">
            Generate Report (Finalize)
        </button>
    </div>
    {% endif %}
</form>

<div id="finalize-modal" class="modal">
    <div class="modal-content">
        <h3>Finalize Daily Balance Report</h3>
        <p>You are about to finalize the daily balance report for {{ target_date }}. A CSV report will be generated.</p>

        <div class="form-group">
            <label>
                <input type="checkbox" id="finalize_send_email" onchange="toggleFinalizeEmailSection()" checked>
                <strong>Send report via email</strong>
            </label>
        </div>

        <div id="finalize-email-section" style="display: block;">
            <div class="email-recipients-section">
                <h4>Email Recipients</h4>
                <div id="finalize-admin-users-list" class="users-list">
                </div>
            </div>

            <div class="form-group" style="margin-top: 1rem;">
                <label>
                    <input type="checkbox" id="finalize_additional_email_checkbox" onchange="toggleFinalizeAdditionalEmail()">
                    Send to additional email address
                </label>
            </div>

            <div id="finalize_additional_email_container" style="display: none; margin-top: 0.5rem;">
                <input type="email"
                       id="finalize_additional_email_input"
                       placeholder="email@example.com"
                       class="form-control">
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeFinalizeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitFinalize()">Finalize Report</button>
        </div>
    </div>
</div>

<script>
const allEmployees = {{ all_employees | tojson }};
const workingEmployeeIds = new Set({{ working_employee_ids | tojson }});

function updateAddEmployeeDropdown() {
    const select = document.getElementById('employee-to-add');
    if (!select) {
        console.log('Employee dropdown not found (likely in read-only mode)');
        return;
    }

    const currentComboIds = new Set();

    document.querySelectorAll('.employee-id-input').forEach(input => {
        currentComboIds.add(input.value);
    });

    select.innerHTML = '<option value="">Select an employee...</option>';

    // Group employees by position
    const employeesByPosition = {};
    allEmployees.forEach(emp => {
        if (!currentComboIds.has(emp.combo_id)) {
            if (!employeesByPosition[emp.position.name]) {
                employeesByPosition[emp.position.name] = [];
            }
            employeesByPosition[emp.position.name].push(emp);
        }
    });

    // Add employees grouped by position using optgroups
    const positionNames = Object.keys(employeesByPosition).sort();
    positionNames.forEach(positionName => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = positionName;

        employeesByPosition[positionName].forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.combo_id;
            option.textContent = emp.display_name;
            option.dataset.employee = JSON.stringify(emp);
            optgroup.appendChild(option);
        });

        select.appendChild(optgroup);
    });
}

function toggleAddEmployeeModal() {
    const modal = document.getElementById('add-employee-modal');
    if (modal.style.display === 'none') {
        updateAddEmployeeDropdown();
        modal.style.display = 'block';
    } else {
        modal.style.display = 'none';
    }
}

function addSelectedEmployee() {
    const select = document.getElementById('employee-to-add');
    const selectedOption = select.options[select.selectedIndex];

    if (!selectedOption.value) {
        alert('Please select an employee');
        return;
    }

    const employee = JSON.parse(selectedOption.dataset.employee);
    addEmployeeEntry(employee);
    toggleAddEmployeeModal();
}

function addEmployeeEntry(emp) {
    const container = document.getElementById('employee-entries');

    const entryDiv = document.createElement('div');
    entryDiv.className = 'employee-entry';
    entryDiv.id = `entry-${emp.combo_id}`;
    entryDiv.dataset.comboId = emp.combo_id;
    entryDiv.dataset.employeeId = emp.id;
    entryDiv.dataset.positionId = emp.position.id;
    entryDiv.dataset.positionName = emp.position.name;
    entryDiv.dataset.displayName = emp.display_name;

    let tipFields = '';
    emp.position.tip_requirements.forEach(req => {
        if (!req.no_input || req.is_total) {
            const requiredMark = req.no_null_value && !req.is_total ? ' <span style="color: #dc2626;">*</span>' : '';
            if (req.is_total) {
                tipFields += `
                    <div class="form-group">
                        <label>${req.name}</label>
                        <input type="number" step="0.01" readonly value="0.00"
                               class="calculated-field tip-total-field"
                               data-combo-id="${emp.combo_id}"
                               data-field-name="${req.field_name}">
                    </div>
                `;
            } else {
                tipFields += `
                    <div class="form-group">
                        <label>${req.name}${requiredMark}</label>
                        <input type="number" step="0.01"
                               name="tip_${req.field_name}_${emp.combo_id}"
                               class="tip-input"
                               data-combo-id="${emp.combo_id}"
                               data-field-name="${req.field_name}"
                               data-is-deduction="${req.is_deduction}"
                               data-record-data="${req.record_data}"
                               data-apply-to-revenue="${req.apply_to_revenue}"
                               data-revenue-is-deduction="${req.revenue_is_deduction}"
                               data-apply-to-expense="${req.apply_to_expense}"
                               data-expense-is-deduction="${req.expense_is_deduction}"
                               value="0.00">
                    </div>
                `;
            }
        } else if (req.no_input) {
            tipFields += `
                <div class="form-group">
                    <div style="font-weight: bold; color: #666; padding: 0.5rem 0;">${req.name}</div>
                </div>
            `;
        }
    });

    entryDiv.innerHTML = `
        <div class="employee-entry-header">
            <h4>${emp.display_name} - ${emp.position.name}</h4>
            <button type="button" class="btn-icon btn-remove" onclick="removeEmployee('${emp.combo_id}')" title="Remove employee">
                <span class="icon">‚àí</span>
            </button>
        </div>
        <input type="hidden" name="employee_ids" value="${emp.combo_id}" class="employee-id-input">
        <div class="form-row">
            ${tipFields}
        </div>
    `;

    // Find the correct insertion point based on position and display name
    const existingEntries = Array.from(container.querySelectorAll('.employee-entry'));
    let insertBeforeElement = null;

    for (const existingEntry of existingEntries) {
        const existingPositionName = existingEntry.dataset.positionName;
        const existingDisplayName = existingEntry.dataset.displayName;

        // Compare position names first
        if (existingPositionName > emp.position.name) {
            insertBeforeElement = existingEntry;
            break;
        } else if (existingPositionName === emp.position.name) {
            // Same position, compare display names
            if (existingDisplayName > emp.display_name) {
                insertBeforeElement = existingEntry;
                break;
            }
        }
    }

    if (insertBeforeElement) {
        container.insertBefore(entryDiv, insertBeforeElement);
    } else {
        container.appendChild(entryDiv);
    }

    attachEmployeeInputListeners(entryDiv);
    calculateEmployeeTipTotals(emp.combo_id);
    updatePositionHeaders();
    updateEmployeeTipsInFinancialTables();
}

function updatePositionHeaders() {
    const container = document.getElementById('employee-entries');

    // Remove all existing position headers
    container.querySelectorAll('.position-group-header').forEach(header => header.remove());

    // Get all employee entries
    const entries = Array.from(container.querySelectorAll('.employee-entry'));

    let lastPositionName = '';
    entries.forEach(entry => {
        const positionName = entry.dataset.positionName;

        // If this is a new position group, add a header before this entry
        if (positionName !== lastPositionName) {
            const headerDiv = document.createElement('div');
            headerDiv.className = 'position-group-header';
            headerDiv.dataset.positionName = positionName;
            headerDiv.innerHTML = `<h5>${positionName}</h5>`;

            container.insertBefore(headerDiv, entry);
            lastPositionName = positionName;
        }
    });
}

function removeEmployee(comboId) {
    if (confirm('Remove this employee from today\'s entries?')) {
        const entry = document.getElementById(`entry-${comboId}`);
        if (entry) {
            entry.remove();
            updatePositionHeaders();
            updateEmployeeTipsInFinancialTables();
            calculateFinancialTotals();
        }
    }
}

function calculateEmployeeTipTotals(comboId) {
    const entry = document.getElementById(`entry-${comboId}`);
    if (!entry) return;

    const tipInputs = entry.querySelectorAll('.tip-input');
    const totalFields = entry.querySelectorAll('.tip-total-field');

    totalFields.forEach(totalField => {
        let total = 0;

        tipInputs.forEach(input => {
            const value = parseFloat(input.value || 0);
            const isDeduction = input.dataset.isDeduction === 'true';
            const recordData = input.dataset.recordData === 'true';

            if (!recordData) {
                if (isDeduction) {
                    total -= value;
                } else {
                    total += value;
                }
            }
        });

        totalField.value = total.toFixed(2);
    });
}

function updateEmployeeTipsInFinancialTables() {
    const revenueTable = document.querySelector('#revenue-table tbody');
    const expenseTable = document.querySelector('#expense-table tbody');

    const existingTipRows = document.querySelectorAll('.employee-tip-row');
    existingTipRows.forEach(row => row.remove());

    const employeeEntries = document.querySelectorAll('.employee-entry');
    const revenueInsertBefore = revenueTable.querySelector('.total-row');
    const expenseInsertBefore = expenseTable.querySelector('.total-row');

    employeeEntries.forEach(entry => {
        const employeeId = entry.dataset.employeeId;
        const employeeDisplayName = entry.querySelector('.employee-entry-header h4').textContent.split(' - ')[0];
        const tipInputs = entry.querySelectorAll('.tip-input');

        tipInputs.forEach(input => {
            const fieldName = input.dataset.fieldName;
            const value = parseFloat(input.value || 0);
            const applyToRevenue = input.dataset.applyToRevenue === 'true';
            const revenueIsDeduction = input.dataset.revenueIsDeduction === 'true';
            const applyToExpense = input.dataset.applyToExpense === 'true';
            const expenseIsDeduction = input.dataset.expenseIsDeduction === 'true';

            if (applyToRevenue && value !== 0) {
                const newRow = document.createElement('tr');
                newRow.className = 'employee-tip-row';
                newRow.dataset.employeeTip = employeeId;
                newRow.dataset.isDeduction = revenueIsDeduction;
                newRow.innerHTML = `
                    <td><label>${employeeDisplayName} - ${fieldName}</label></td>
                    <td>
                        <input type="number" step="0.01" readonly class="table1-field calculated-field" value="${value.toFixed(2)}">
                    </td>
                `;
                revenueTable.insertBefore(newRow, revenueInsertBefore);
            }

            if (applyToExpense && value !== 0) {
                const newRow = document.createElement('tr');
                newRow.className = 'employee-tip-row';
                newRow.dataset.employeeTip = employeeId;
                newRow.dataset.isDeduction = expenseIsDeduction;
                newRow.innerHTML = `
                    <td><label>${employeeDisplayName} - ${fieldName}</label></td>
                    <td>
                        <input type="number" step="0.01" readonly class="table2-field calculated-field" value="${value.toFixed(2)}">
                    </td>
                `;
                expenseTable.insertBefore(newRow, expenseInsertBefore);
            }
        });
    });

    calculateFinancialTotals();
}

function attachEmployeeInputListeners(container) {
    const inputs = container.querySelectorAll('.tip-input');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            const comboId = this.dataset.comboId;
            calculateEmployeeTipTotals(comboId);
            updateEmployeeTipsInFinancialTables();
            if (this.value !== '') {
                this.classList.remove('field-error-highlight');
            }
        });
        // Add select-on-focus behavior
        input.addEventListener('focus', function() {
            this.select();
        });
    });
}

function addSelectOnFocusBehavior(inputs) {
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.select();
        });
    });
}

function calculateFinancialTotals() {
    console.log('=== calculateFinancialTotals called ===');
    const table1Rows = document.querySelectorAll('#revenue-table tbody tr:not(.total-row)');
    console.log('Revenue rows found:', table1Rows.length);
    let table1Total = 0;

    table1Rows.forEach((row, index) => {
        const field = row.querySelector('.table1-field');
        console.log(`Row ${index}:`, field ? `value=${field.value}, isDeduction=${row.dataset.isDeduction}` : 'NO FIELD FOUND');
        if (field) {
            const value = parseFloat(field.value) || 0;
            const isDeduction = row.dataset.isDeduction === 'true';
            if (isDeduction) {
                table1Total -= value;
            } else {
                table1Total += value;
            }
        }
    });

    console.log('Revenue total calculated:', table1Total);
    document.getElementById('table1_total').value = table1Total.toFixed(2);

    const table2Rows = document.querySelectorAll('#expense-table tbody tr:not(.total-row):not(.highlight-row)');
    console.log('Expense rows found:', table2Rows.length);
    let table2Total = 0;

    table2Rows.forEach((row, index) => {
        const field = row.querySelector('.table2-field');
        console.log(`Expense row ${index}:`, field ? `value=${field.value}, isDeduction=${row.dataset.isDeduction}` : 'NO FIELD FOUND');
        if (field) {
            const value = parseFloat(field.value) || 0;
            const isDeduction = row.dataset.isDeduction === 'true';
            if (isDeduction) {
                table2Total -= value;
            } else {
                table2Total += value;
            }
        }
    });

    console.log('Expense total calculated:', table2Total);
    document.getElementById('table2_total').value = table2Total.toFixed(2);

    const cashOverUnder = table2Total - table1Total;
    const cashOverUnderField = document.getElementById('cash_over_under');
    cashOverUnderField.value = cashOverUnder.toFixed(2);

    if (cashOverUnder > 0) {
        cashOverUnderField.style.color = '#059669';
    } else if (cashOverUnder < 0) {
        cashOverUnderField.style.color = '#dc2626';
    } else {
        cashOverUnderField.style.color = '#000';
    }
}

let currentManageCategory = 'revenue';
let isManagementModeActive = {
    revenue: false,
    expense: false
};

function toggleManagementMode(category) {
    const isActive = isManagementModeActive[category];
    const buttonTextElement = document.getElementById(`manage-${category}-text`);
    const modal = document.getElementById('manage-items-modal');
    const title = document.getElementById('manage-items-title');

    const tableId = category === 'revenue' ? 'revenue-table' : 'expense-table';
    const controls = document.querySelectorAll(`#${tableId} .item-management-controls`);

    if (!isActive) {
        controls.forEach(control => control.style.display = 'inline');
        buttonTextElement.textContent = 'Add New Item';
        isManagementModeActive[category] = true;

        currentManageCategory = category;
        title.textContent = category === 'revenue' ? 'Add Revenue & Income Item' : 'Add Deposits & Expenses Item';
        document.getElementById('new-item-name').value = '';
        document.getElementById('new-item-is-deduction').checked = false;
        document.getElementById('new-item-is-starting-till').checked = false;
        document.getElementById('new-item-is-ending-till').checked = false;
        modal.style.display = 'block';
    } else {
        controls.forEach(control => control.style.display = 'none');
        buttonTextElement.textContent = 'Manage Items';
        isManagementModeActive[category] = false;
        modal.style.display = 'none';
    }
}

function closeManageModal() {
    const modal = document.getElementById('manage-items-modal');
    modal.style.display = 'none';
}

async function addFinancialTemplate() {
    const nameInput = document.getElementById('new-item-name');
    const isDeductionInput = document.getElementById('new-item-is-deduction');
    const isStartingTillInput = document.getElementById('new-item-is-starting-till');
    const isEndingTillInput = document.getElementById('new-item-is-ending-till');
    const name = nameInput.value.trim();
    const isDeduction = isDeductionInput.checked;
    const isStartingTill = isStartingTillInput.checked;
    const isEndingTill = isEndingTillInput.checked;

    if (!name) {
        alert('Please enter an item name');
        return;
    }

    try {
        const response = await fetch('/api/financial-items/templates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                category: currentManageCategory,
                is_deduction: isDeduction,
                is_starting_till: isStartingTill,
                is_ending_till: isEndingTill
            })
        });

        if (!response.ok) {
            throw new Error('Failed to add item');
        }

        const newTemplate = await response.json();

        const tableId = currentManageCategory === 'revenue' ? 'revenue-table' : 'expense-table';
        const fieldClass = currentManageCategory === 'revenue' ? 'table1-field' : 'table2-field';
        const table = document.querySelector(`#${tableId} tbody`);
        const totalRow = table.querySelector('.total-row');

        const newRow = document.createElement('tr');
        newRow.dataset.templateId = newTemplate.id;
        newRow.dataset.templateName = newTemplate.name;
        newRow.dataset.isDeduction = newTemplate.is_deduction;
        newRow.dataset.isStartingTill = newTemplate.is_starting_till;
        newRow.dataset.isEndingTill = newTemplate.is_ending_till;
        newRow.innerHTML = `
            <td>
                <span class="item-name-display" id="name-display-${newTemplate.id}">
                    ${newTemplate.name}
                    ${newTemplate.is_deduction ? '<span style="color: #dc2626; font-weight: bold;" title="This item subtracts from the total"> (‚àí)</span>' : ''}
                    ${newTemplate.is_starting_till ? '<span style="color: #2563eb; font-weight: bold;" title="Auto-populated from previous day"> (‚ü≤)</span>' : ''}
                    ${newTemplate.is_ending_till ? '<span style="color: #059669; font-weight: bold;" title="Ending till for next day"> (‚§µ)</span>' : ''}
                </span>
                <input type="text" class="item-name-edit" id="name-edit-${newTemplate.id}" value="${newTemplate.name}" style="display: none;">
                <span class="item-management-controls" style="display: ${isManagementModeActive[currentManageCategory] ? 'inline' : 'none'};">
                    <button type="button" class="btn-icon btn-edit-small" onclick="startEditItemName(${newTemplate.id})" id="edit-btn-${newTemplate.id}" title="Rename item">
                        <span class="icon">‚úé</span>
                    </button>
                    <button type="button" class="btn-icon btn-save-small" onclick="saveItemName(${newTemplate.id}, '${currentManageCategory}')" id="save-btn-${newTemplate.id}" style="display: none;" title="Save">
                        <span class="icon">‚úì</span>
                    </button>
                    <button type="button" class="btn-icon btn-cancel-small" onclick="cancelEditItemName(${newTemplate.id})" id="cancel-btn-${newTemplate.id}" style="display: none;" title="Cancel">
                        <span class="icon">‚úó</span>
                    </button>
                    <button type="button" class="btn-icon btn-remove-small" onclick="deleteFinancialTemplate(${newTemplate.id}, '${currentManageCategory}')" title="Remove item">
                        <span class="icon">√ó</span>
                    </button>
                    <label style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;">
                        <input type="checkbox" onchange="toggleDeduction(${newTemplate.id}, '${currentManageCategory}', this.checked)" ${newTemplate.is_deduction ? 'checked' : ''} title="Mark as deduction">
                        <span style="font-size: 12px;">Deduction</span>
                    </label>
                    <label style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;">
                        <input type="checkbox" onchange="toggleStartingTill(${newTemplate.id}, '${currentManageCategory}', this.checked)" ${newTemplate.is_starting_till ? 'checked' : ''} title="Auto-populate from previous day">
                        <span style="font-size: 12px;">Starting Till</span>
                    </label>
                    <label style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;">
                        <input type="checkbox" onchange="toggleEndingTill(${newTemplate.id}, '${currentManageCategory}', this.checked)" ${newTemplate.is_ending_till ? 'checked' : ''} title="Ending till for next day">
                        <span style="font-size: 12px;">Ending Till</span>
                    </label>
                </span>
            </td>
            <td>
                <input type="number" step="0.01"
                       name="financial_item_${newTemplate.id}"
                       class="${fieldClass}"
                       value="0.00">
            </td>
        `;

        table.insertBefore(newRow, totalRow);

        const inputField = newRow.querySelector(`.${fieldClass}`);
        inputField.addEventListener('input', function() {
            calculateFinancialTotals();
            if (this.value !== '') {
                this.classList.remove('field-error-highlight');
            }
        });
        // Add select-on-focus behavior to the new input
        inputField.addEventListener('focus', function() {
            this.select();
        });

        nameInput.value = '';
        isDeductionInput.checked = false;
        isStartingTillInput.checked = false;
        isEndingTillInput.checked = false;
        calculateFinancialTotals();

        alert('Item added successfully! It will appear on all future days.');

    } catch (error) {
        console.error('Error adding financial template:', error);
        alert('Failed to add item. Please try again.');
    }
}

function startEditItemName(templateId) {
    const display = document.getElementById(`name-display-${templateId}`);
    const edit = document.getElementById(`name-edit-${templateId}`);
    const editBtn = document.getElementById(`edit-btn-${templateId}`);
    const saveBtn = document.getElementById(`save-btn-${templateId}`);
    const cancelBtn = document.getElementById(`cancel-btn-${templateId}`);

    display.style.display = 'none';
    edit.style.display = 'inline-block';
    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';

    edit.focus();
    edit.select();
}

function cancelEditItemName(templateId) {
    const display = document.getElementById(`name-display-${templateId}`);
    const edit = document.getElementById(`name-edit-${templateId}`);
    const editBtn = document.getElementById(`edit-btn-${templateId}`);
    const saveBtn = document.getElementById(`save-btn-${templateId}`);
    const cancelBtn = document.getElementById(`cancel-btn-${templateId}`);

    const row = document.querySelector(`tr[data-template-id="${templateId}"]`);
    edit.value = row.dataset.templateName;

    display.style.display = 'inline';
    edit.style.display = 'none';
    editBtn.style.display = 'inline-block';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
}

async function saveItemName(templateId, category) {
    const edit = document.getElementById(`name-edit-${templateId}`);
    const newName = edit.value.trim();

    if (!newName) {
        alert('Item name cannot be empty');
        return;
    }

    try {
        const response = await fetch(`/api/financial-items/templates/${templateId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: newName
            })
        });

        if (!response.ok) {
            throw new Error('Failed to update item name');
        }

        const display = document.getElementById(`name-display-${templateId}`);
        const editBtn = document.getElementById(`edit-btn-${templateId}`);
        const saveBtn = document.getElementById(`save-btn-${templateId}`);
        const cancelBtn = document.getElementById(`cancel-btn-${templateId}`);
        const row = document.querySelector(`tr[data-template-id="${templateId}"]`);

        display.textContent = newName;
        row.dataset.templateName = newName;

        display.style.display = 'inline';
        edit.style.display = 'none';
        editBtn.style.display = 'inline-block';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';

    } catch (error) {
        console.error('Error updating item name:', error);
        alert('Failed to update item name. Please try again.');
    }
}

async function deleteFinancialTemplate(templateId, category) {
    if (!confirm('Are you sure you want to remove this item? It will be removed from all future days (existing data will not be affected).')) {
        return;
    }

    try {
        const response = await fetch(`/api/financial-items/templates/${templateId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.detail || 'Failed to delete item');
        }

        const tableId = category === 'revenue' ? 'revenue-table' : 'expense-table';
        const row = document.querySelector(`#${tableId} tr[data-template-id="${templateId}"]`);
        if (row) {
            row.remove();
            calculateFinancialTotals();
        }

    } catch (error) {
        console.error('Error deleting financial template:', error);
        alert(error.message || 'Failed to delete item. Please try again.');
    }
}

async function toggleDeduction(templateId, category, isDeduction) {
    const tableId = category === 'revenue' ? 'revenue-table' : 'expense-table';
    const row = document.querySelector(`#${tableId} tr[data-template-id="${templateId}"]`);
    const templateName = row.dataset.templateName;
    const isStartingTill = row.dataset.isStartingTill === 'true';
    const isEndingTill = row.dataset.isEndingTill === 'true';

    try {
        const response = await fetch(`/api/financial-items/templates/${templateId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: templateName,
                is_deduction: isDeduction,
                is_starting_till: isStartingTill,
                is_ending_till: isEndingTill
            })
        });

        if (!response.ok) {
            throw new Error('Failed to update deduction status');
        }

        row.dataset.isDeduction = isDeduction;

        const nameDisplay = row.querySelector(`#name-display-${templateId}`);
        const existingDeductionIndicator = nameDisplay.querySelector('span[title="This item subtracts from the total"]');

        if (isDeduction && !existingDeductionIndicator) {
            const indicator = document.createElement('span');
            indicator.style.color = '#dc2626';
            indicator.style.fontWeight = 'bold';
            indicator.title = 'This item subtracts from the total';
            indicator.textContent = ' (‚àí)';
            nameDisplay.appendChild(indicator);
        } else if (!isDeduction && existingDeductionIndicator) {
            existingDeductionIndicator.remove();
        }

        calculateFinancialTotals();

    } catch (error) {
        console.error('Error toggling deduction:', error);
        alert('Failed to update deduction status. Please try again.');
        const checkbox = row.querySelector('input[type="checkbox"]');
        if (checkbox) {
            checkbox.checked = !isDeduction;
        }
    }
}

async function toggleStartingTill(templateId, category, isStartingTill) {
    const tableId = category === 'revenue' ? 'revenue-table' : 'expense-table';
    const row = document.querySelector(`#${tableId} tr[data-template-id="${templateId}"]`);
    const templateName = row.dataset.templateName;
    const isDeduction = row.dataset.isDeduction === 'true';
    const isEndingTill = row.dataset.isEndingTill === 'true';

    try {
        const response = await fetch(`/api/financial-items/templates/${templateId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: templateName,
                is_deduction: isDeduction,
                is_starting_till: isStartingTill,
                is_ending_till: isEndingTill
            })
        });

        if (!response.ok) {
            throw new Error('Failed to update starting till status');
        }

        row.dataset.isStartingTill = isStartingTill;

        const nameDisplay = row.querySelector(`#name-display-${templateId}`);
        const existingStartingTillIndicator = nameDisplay.querySelector('span[title="Auto-populated from previous day"]');

        if (isStartingTill && !existingStartingTillIndicator) {
            const indicator = document.createElement('span');
            indicator.style.color = '#2563eb';
            indicator.style.fontWeight = 'bold';
            indicator.title = 'Auto-populated from previous day';
            indicator.textContent = ' (‚ü≤)';
            nameDisplay.appendChild(indicator);

            const input = row.querySelector('input[type="number"]');
            if (input && !input.value || parseFloat(input.value) === 0) {
                const previousTotal = parseFloat('{{ previous_ending_till }}') || 0;
                input.value = previousTotal.toFixed(2);
                calculateFinancialTotals();
            }
        } else if (!isStartingTill && existingStartingTillIndicator) {
            existingStartingTillIndicator.remove();
        }

    } catch (error) {
        console.error('Error toggling starting till:', error);
        alert('Failed to update starting till status. Please try again.');
        const checkbox = row.querySelectorAll('input[type="checkbox"]')[1];
        if (checkbox) {
            checkbox.checked = !isStartingTill;
        }
    }
}

async function toggleEndingTill(templateId, category, isEndingTill) {
    const tableId = category === 'revenue' ? 'revenue-table' : 'expense-table';
    const row = document.querySelector(`#${tableId} tr[data-template-id="${templateId}"]`);
    const templateName = row.dataset.templateName;
    const isDeduction = row.dataset.isDeduction === 'true';
    const isStartingTill = row.dataset.isStartingTill === 'true';

    try {
        const response = await fetch(`/api/financial-items/templates/${templateId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: templateName,
                is_deduction: isDeduction,
                is_starting_till: isStartingTill,
                is_ending_till: isEndingTill
            })
        });

        if (!response.ok) {
            throw new Error('Failed to update ending till status');
        }

        row.dataset.isEndingTill = isEndingTill;

        const nameDisplay = row.querySelector(`#name-display-${templateId}`);
        const existingEndingTillIndicator = nameDisplay.querySelector('span[title="Ending till for next day"]');

        if (isEndingTill && !existingEndingTillIndicator) {
            const indicator = document.createElement('span');
            indicator.style.color = '#059669';
            indicator.style.fontWeight = 'bold';
            indicator.title = 'Ending till for next day';
            indicator.textContent = ' (‚§µ)';
            nameDisplay.appendChild(indicator);
        } else if (!isEndingTill && existingEndingTillIndicator) {
            existingEndingTillIndicator.remove();
        }

    } catch (error) {
        console.error('Error toggling ending till:', error);
        alert('Failed to update ending till status. Please try again.');
        const checkbox = row.querySelectorAll('input[type="checkbox"]')[2];
        if (checkbox) {
            checkbox.checked = !isEndingTill;
        }
    }
}

let finalizeAdminUsers = [];

async function loadFinalizeAdminUsers() {
    try {
        const response = await fetch('/reports/api/admin-users?report_type=daily');
        const result = await response.json();
        if (result.success) {
            finalizeAdminUsers = result.users;
            renderFinalizeUserList();
        }
    } catch (error) {
        console.error('Failed to load admin users:', error);
    }
}

function renderFinalizeUserList() {
    const container = document.getElementById('finalize-admin-users-list');
    if (!container) return;

    if (finalizeAdminUsers.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic;">No admin users with emails found.</p>';
        return;
    }

    let html = '';
    finalizeAdminUsers.forEach(user => {
        html += `
            <label class="user-checkbox-label">
                <input type="checkbox"
                       name="finalize_user_email"
                       value="${user.email}"
                       data-user-id="${user.id}"
                       ${user.opt_in ? 'checked' : ''}>
                <span>${user.username} (${user.email})</span>
            </label>
        `;
    });

    container.innerHTML = html;
}

function validateAndOpenFinalizeModal() {
    if (validateFormBeforeSubmit(null, true)) {
        openFinalizeModal();
    }
}

function openFinalizeModal() {
    loadFinalizeAdminUsers();
    const modal = document.getElementById('finalize-modal');
    modal.classList.add('active');
}

function closeFinalizeModal() {
    const modal = document.getElementById('finalize-modal');
    modal.classList.remove('active');
    document.getElementById('finalize_send_email').checked = true;
    document.getElementById('finalize-email-section').style.display = 'block';
}

function toggleFinalizeEmailSection() {
    const checkbox = document.getElementById('finalize_send_email');
    const section = document.getElementById('finalize-email-section');
    section.style.display = checkbox.checked ? 'block' : 'none';
}

function toggleFinalizeAdditionalEmail() {
    const checkbox = document.getElementById('finalize_additional_email_checkbox');
    const container = document.getElementById('finalize_additional_email_container');
    if (checkbox.checked) {
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
        document.getElementById('finalize_additional_email_input').value = '';
    }
}

function validateFormBeforeSubmit(event, isForFinalize) {
    const errors = [];
    const invalidFields = [];

    document.querySelectorAll('.field-error-highlight').forEach(el => {
        el.classList.remove('field-error-highlight');
    });

    document.querySelectorAll('.table1-field, .table2-field').forEach(field => {
        if (!field.classList.contains('calculated-field') && (field.value === '' || field.value === null)) {
            const row = field.closest('tr');
            const label = row.querySelector('td:first-child .item-name-display, td:first-child label');
            let fieldName = 'Unknown field';
            if (label) {
                const textContent = label.textContent.trim();
                fieldName = textContent.split('(')[0].trim();
            }
            errors.push(`‚Ä¢ ${fieldName}`);
            field.classList.add('field-error-highlight');
            invalidFields.push(field);
        }
    });

    document.querySelectorAll('.tip-input').forEach(field => {
        if (field.value === '' || field.value === null) {
            const formGroup = field.closest('.form-group');
            const label = formGroup ? formGroup.querySelector('label') : null;
            let fieldName = 'Unknown field';
            if (label) {
                const textContent = label.textContent.trim();
                fieldName = textContent.replace('*', '').trim();
            }
            const employeeEntry = field.closest('.employee-entry');
            const employeeHeader = employeeEntry ? employeeEntry.querySelector('.employee-entry-header h4') : null;
            const employeeName = employeeHeader ? employeeHeader.textContent.trim() : 'Unknown employee';

            errors.push(`‚Ä¢ ${employeeName} - ${fieldName}`);
            field.classList.add('field-error-highlight');
            invalidFields.push(field);
        }
    });

    if (errors.length > 0) {
        let errorMessage = `Found ${errors.length} field(s) that cannot be blank. Enter 0 if the value is zero.\n\nFields requiring attention:\n\n`;
        errorMessage += errors.join('\n');
        alert(errorMessage);

        if (invalidFields.length > 0) {
            invalidFields[0].focus();
            invalidFields[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        if (event) {
            event.preventDefault();
        }
        return false;
    }

    return true;
}

async function submitFinalize() {
    if (!validateFormBeforeSubmit(null, true)) {
        closeFinalizeModal();
        return;
    }

    const form = document.getElementById('dailyBalanceForm');
    const formData = new FormData(form);
    const targetDate = formData.get('target_date');

    const sendEmail = document.getElementById('finalize_send_email').checked;

    try {
        const response = await fetch('/daily-balance/finalize', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            if (sendEmail) {
                const selectedEmails = [];
                const checkboxes = document.querySelectorAll('input[name="finalize_user_email"]:checked');
                checkboxes.forEach(cb => selectedEmails.push(cb.value));

                const additionalEmailCheckbox = document.getElementById('finalize_additional_email_checkbox');
                const additionalEmailInput = document.getElementById('finalize_additional_email_input');

                if (additionalEmailCheckbox && additionalEmailCheckbox.checked) {
                    const additionalEmail = additionalEmailInput.value.trim();
                    if (additionalEmail) {
                        selectedEmails.push(additionalEmail);
                    }
                }

                if (selectedEmails.length > 0) {
                    const emailFormData = new FormData();
                    selectedEmails.forEach(email => emailFormData.append('user_emails[]', email));
                    emailFormData.append('start_date', targetDate);
                    emailFormData.append('end_date', targetDate);

                    const emailResponse = await fetch('/reports/daily-balance/email', {
                        method: 'POST',
                        body: emailFormData
                    });

                    const emailResult = await emailResponse.json();
                    if (emailResult.success) {
                        alert(emailResult.message);
                    } else {
                        alert('Warning: ' + emailResult.message);
                    }
                }
            }

            window.location.href = `/daily-balance?selected_date=${targetDate}`;
        } else {
            alert('Failed to finalize report. Please try again.');
        }
    } catch (error) {
        console.error('Error finalizing report:', error);
        alert('An error occurred. Please try again.');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== Page loaded, initializing ===');
    updateAddEmployeeDropdown();

    // Add input listeners and select-on-focus for financial fields
    document.querySelectorAll('.table1-field, .table2-field').forEach(field => {
        field.addEventListener('input', function() {
            calculateFinancialTotals();
            if (this.value !== '') {
                this.classList.remove('field-error-highlight');
            }
        });
    });

    // Add select-on-focus to all number inputs (financial and employee)
    addSelectOnFocusBehavior(document.querySelectorAll('.table1-field, .table2-field, .tip-input'));

    document.querySelectorAll('.employee-entry').forEach(entry => {
        attachEmployeeInputListeners(entry);
    });

    const previousEndingTill = parseFloat('{{ previous_ending_till }}') || 0;
    const hasDailyBalance = {{ 'true' if daily_balance else 'false' }};

    if (!hasDailyBalance && previousEndingTill > 0) {
        document.querySelectorAll('#revenue-table tr[data-is-starting-till="true"], #expense-table tr[data-is-starting-till="true"]').forEach(row => {
            const input = row.querySelector('input[type="number"]');
            if (input) {
                input.value = previousEndingTill.toFixed(2);
            }
        });
    }

    console.log('=== Calling calculateFinancialTotals on page load ===');
    calculateFinancialTotals();

    document.querySelectorAll('.employee-entry').forEach(entry => {
        const employeeId = entry.dataset.employeeId;
        calculateEmployeeTipTotals(employeeId);
    });

    updateEmployeeTipsInFinancialTables();
});
</script>

<style>
.report-metadata {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1rem 0 2rem 0;
}

.report-metadata h4 {
    margin: 0 0 1rem 0;
    color: #495057;
    font-size: 1rem;
    font-weight: 600;
}

.metadata-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.metadata-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.metadata-label {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
}

.metadata-value {
    font-size: 1rem;
    color: #212529;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
}

.modal.active {
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    padding: 2rem;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-content h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: #2c3e50;
}

.modal-content h4 {
    margin-top: 0;
    margin-bottom: 0.5rem;
    font-size: 1rem;
    color: #2c3e50;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 2rem;
}

.email-recipients-section {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 4px;
    margin-top: 1rem;
}

.users-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.user-checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: white;
    border-radius: 4px;
    cursor: pointer;
}

.user-checkbox-label:hover {
    background: #e9ecef;
}

.user-checkbox-label input[type="checkbox"] {
    cursor: pointer;
}

.alert-error {
    background-color: #fee;
    border: 1px solid #fcc;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
    color: #c00;
}

.field-error-highlight {
    border: 2px solid #dc2626 !important;
    background-color: #fee !important;
}
</style>
{% endblock %}
