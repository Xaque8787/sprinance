{% extends "base.html" %}

{% block title %}Daily Balance - {{ target_date }} - Management System{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Daily Balance</h2>
    <form method="GET" action="/daily-balance" style="display: inline-block;">
        <input type="date" name="selected_date" value="{{ target_date }}" onchange="this.form.submit()">
    </form>
</div>

<div class="daily-info">
    <h3>{{ target_date }} - {{ day_of_week }}</h3>
    {% if daily_balance and daily_balance.finalized %}
        {% if edit_mode %}
        <span class="badge badge-warning">Editing Finalized Report</span>
        {% else %}
        <span class="badge badge-success">Finalized</span>
        {% endif %}
    {% endif %}
</div>

{% if edit_mode %}
<div class="alert alert-warning">
    <strong>⚠️ Warning:</strong> You are editing a finalized report. Changes will overwrite the existing database entry and CSV file when saved.
</div>
{% endif %}

<form method="POST" action="{% if daily_balance and daily_balance.finalized %}/daily-balance/save{% else %}/daily-balance/save{% endif %}" id="dailyBalanceForm">
    <input type="hidden" name="target_date" value="{{ target_date }}">

    <div class="form-section">
        <h3>Daily Financial Summary</h3>

        <div class="financial-tables-container">
            <div class="financial-table">
                <h4>Revenue & Income</h4>
                <table class="summary-table">
                    <tbody>
                        <tr>
                            <td><label for="cash_drawers_beginning">Cash Drawers Beginning</label></td>
                            <td>
                                <input type="number" step="0.01" id="cash_drawers_beginning" name="cash_drawers_beginning"
                                       class="table1-field"
                                       value="{% if daily_balance %}{{ daily_balance.cash_drawers_beginning }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="food_sales">Food Sales</label></td>
                            <td>
                                <input type="number" step="0.01" id="food_sales" name="food_sales"
                                       class="table1-field"
                                       value="{% if daily_balance %}{{ daily_balance.food_sales }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="non_alcohol_beverage_sales">Non Alcohol Beverage Sales</label></td>
                            <td>
                                <input type="number" step="0.01" id="non_alcohol_beverage_sales" name="non_alcohol_beverage_sales"
                                       class="table1-field"
                                       value="{% if daily_balance %}{{ daily_balance.non_alcohol_beverage_sales }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="beer_sales">Beer Sales</label></td>
                            <td>
                                <input type="number" step="0.01" id="beer_sales" name="beer_sales"
                                       class="table1-field"
                                       value="{% if daily_balance %}{{ daily_balance.beer_sales }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="wine_sales">Wine Sales</label></td>
                            <td>
                                <input type="number" step="0.01" id="wine_sales" name="wine_sales"
                                       class="table1-field"
                                       value="{% if daily_balance %}{{ daily_balance.wine_sales }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="other_revenue">Other Revenue</label></td>
                            <td>
                                <input type="number" step="0.01" id="other_revenue" name="other_revenue"
                                       class="table1-field"
                                       value="{% if daily_balance %}{{ daily_balance.other_revenue }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="catering_sales">Catering Sales</label></td>
                            <td>
                                <input type="number" step="0.01" id="catering_sales" name="catering_sales"
                                       class="table1-field"
                                       value="{% if daily_balance %}{{ daily_balance.catering_sales }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="fundraising_contributions">Fundraising Contributions</label></td>
                            <td>
                                <input type="number" step="0.01" id="fundraising_contributions" name="fundraising_contributions"
                                       class="table1-field"
                                       value="{% if daily_balance %}{{ daily_balance.fundraising_contributions }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="sales_tax_payable">Sales Tax Payable</label></td>
                            <td>
                                <input type="number" step="0.01" id="sales_tax_payable" name="sales_tax_payable"
                                       class="table1-field"
                                       value="{% if daily_balance %}{{ daily_balance.sales_tax_payable }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="gift_certificate_sold">Gift Certificate Sold</label></td>
                            <td>
                                <input type="number" step="0.01" id="gift_certificate_sold" name="gift_certificate_sold"
                                       class="table1-field"
                                       value="{% if daily_balance %}{{ daily_balance.gift_certificate_sold }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>Total</strong></td>
                            <td>
                                <input type="number" step="0.01" id="table1_total" readonly class="total-field" value="0.00">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="financial-table">
                <h4>Deposits & Expenses</h4>
                <table class="summary-table">
                    <tbody>
                        <tr>
                            <td><label for="gift_certificate_redeemed">Gift Certificate Redeemed</label></td>
                            <td>
                                <input type="number" step="0.01" id="gift_certificate_redeemed" name="gift_certificate_redeemed"
                                       class="table2-field"
                                       value="{% if daily_balance %}{{ daily_balance.gift_certificate_redeemed }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="checking_account_cash_deposit">Checking Account Cash Deposit</label></td>
                            <td>
                                <input type="number" step="0.01" id="checking_account_cash_deposit" name="checking_account_cash_deposit"
                                       class="table2-field"
                                       value="{% if daily_balance %}{{ daily_balance.checking_account_cash_deposit }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="checking_account_bank_cards">Checking Account Bank Cards</label></td>
                            <td>
                                <input type="number" step="0.01" id="checking_account_bank_cards" name="checking_account_bank_cards"
                                       class="table2-field"
                                       value="{% if daily_balance %}{{ daily_balance.checking_account_bank_cards }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="cash_paid_out">Cash Paid Out</label></td>
                            <td>
                                <input type="number" step="0.01" id="cash_paid_out" name="cash_paid_out"
                                       class="table2-field"
                                       value="{% if daily_balance %}{{ daily_balance.cash_paid_out }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="cash_drawers_end">Cash Drawers End</label></td>
                            <td>
                                <input type="number" step="0.01" id="cash_drawers_end" name="cash_drawers_end"
                                       class="table2-field"
                                       value="{% if daily_balance %}{{ daily_balance.cash_drawers_end }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>Total</strong></td>
                            <td>
                                <input type="number" step="0.01" id="table2_total" readonly class="total-field" value="0.00">
                            </td>
                        </tr>
                        <tr class="highlight-row">
                            <td><strong>Cash Over/Under</strong></td>
                            <td>
                                <input type="number" step="0.01" id="cash_over_under" readonly class="total-field highlight-field" value="0.00">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="notes">Notes</label>
            <textarea id="notes" name="notes" rows="3"
                      {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>{% if daily_balance %}{{ daily_balance.notes }}{% endif %}</textarea>
        </div>
    </div>

    <div class="form-section">
        <div class="section-header">
            <h3>Employee Entries</h3>
            {% if not (daily_balance and daily_balance.finalized and not edit_mode) %}
            <button type="button" class="btn btn-sm" onclick="toggleAddEmployeeModal()">
                <span class="icon">+</span> Add Employee
            </button>
            {% endif %}
        </div>

        {% if not (daily_balance and daily_balance.finalized and not edit_mode) %}
        <div id="add-employee-modal" class="add-employee-modal" style="display: none;">
            <div class="modal-content-inline">
                <h4>Add Employee</h4>
                <select id="employee-to-add" class="employee-add-select">
                    <option value="">Select an employee...</option>
                </select>
                <button type="button" class="btn btn-primary btn-sm" onclick="addSelectedEmployee()">Add</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleAddEmployeeModal()">Cancel</button>
            </div>
        </div>
        {% endif %}

        <div id="employee-entries">
            {% for emp in working_employees %}
            <div class="employee-entry" id="entry-{{ emp.id }}" data-employee-id="{{ emp.id }}">
                <div class="employee-entry-header">
                    <h4>{{ emp.name }} - {{ emp.position.name }}</h4>
                    {% if not (daily_balance and daily_balance.finalized and not edit_mode) %}
                    <button type="button" class="btn-icon btn-remove" onclick="removeEmployee({{ emp.id }})" title="Remove employee">
                        <span class="icon">−</span>
                    </button>
                    {% endif %}
                </div>
                <input type="hidden" name="employee_ids" value="{{ emp.id }}" class="employee-id-input">

                <div class="form-row">
                    {% for req in emp.position.tip_requirements %}
                        {% if req.field_name != 'no_tips' %}
                        <div class="form-group">
                            <label>{{ req.name }}</label>
                            {% if req.field_name == 'calculated_take_home' %}
                            <input type="number" step="0.01" readonly
                                   value="{% if employee_entries.get(emp.id) %}{{ employee_entries.get(emp.id).calculated_take_home }}{% else %}0.00{% endif %}"
                                   class="calculated-field">
                            {% elif req.field_name == 'bank_card_sales' %}
                            <input type="number" step="0.01" name="bank_card_sales_{{ emp.id }}"
                                   value="{% if employee_entries.get(emp.id) %}{{ employee_entries.get(emp.id).bank_card_sales }}{% else %}0.00{% endif %}"
                                   {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            {% elif req.field_name == 'bank_card_tips' %}
                            <input type="number" step="0.01" name="bank_card_tips_{{ emp.id }}"
                                   value="{% if employee_entries.get(emp.id) %}{{ employee_entries.get(emp.id).bank_card_tips }}{% else %}0.00{% endif %}"
                                   {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            {% elif req.field_name == 'total_sales' %}
                            <input type="number" step="0.01" name="total_sales_{{ emp.id }}"
                                   value="{% if employee_entries.get(emp.id) %}{{ employee_entries.get(emp.id).total_sales }}{% else %}0.00{% endif %}"
                                   {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            {% elif req.field_name == 'cash_tips' %}
                            <input type="number" step="0.01" name="cash_tips_{{ emp.id }}"
                                   value="{% if employee_entries.get(emp.id) %}{{ employee_entries.get(emp.id).cash_tips }}{% else %}0.00{% endif %}"
                                   {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}

                    <div class="form-group">
                        <label>Adjustments</label>
                        <input type="number" step="0.01" name="adjustments_{{ emp.id }}"
                               value="{% if employee_entries.get(emp.id) %}{{ employee_entries.get(emp.id).adjustments }}{% else %}0.00{% endif %}"
                               {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    {% if not (daily_balance and daily_balance.finalized and not edit_mode) %}
    <div class="form-actions">
        <button type="submit" class="btn btn-secondary" formaction="/daily-balance/save">Save Draft</button>
        <button type="submit" class="btn btn-primary" formaction="/daily-balance/finalize"
                onclick="return confirm('Are you sure you want to finalize this daily balance? A CSV report will be generated.')">
            Generate Report (Finalize)
        </button>
    </div>
    {% endif %}
</form>

<script>
const allEmployees = {{ all_employees | tojson }};
const workingEmployeeIds = new Set({{ working_employee_ids | tojson }});

function updateAddEmployeeDropdown() {
    const select = document.getElementById('employee-to-add');
    const currentEmployeeIds = new Set();

    document.querySelectorAll('.employee-id-input').forEach(input => {
        currentEmployeeIds.add(parseInt(input.value));
    });

    select.innerHTML = '<option value="">Select an employee...</option>';

    allEmployees.forEach(emp => {
        if (!currentEmployeeIds.has(emp.id)) {
            const option = document.createElement('option');
            option.value = emp.id;
            option.textContent = `${emp.name} (${emp.position.name})`;
            option.dataset.employee = JSON.stringify(emp);
            select.appendChild(option);
        }
    });
}

function toggleAddEmployeeModal() {
    const modal = document.getElementById('add-employee-modal');
    if (modal.style.display === 'none') {
        updateAddEmployeeDropdown();
        modal.style.display = 'block';
    } else {
        modal.style.display = 'none';
    }
}

function addSelectedEmployee() {
    const select = document.getElementById('employee-to-add');
    const selectedOption = select.options[select.selectedIndex];

    if (!selectedOption.value) {
        alert('Please select an employee');
        return;
    }

    const employee = JSON.parse(selectedOption.dataset.employee);
    addEmployeeEntry(employee);
    toggleAddEmployeeModal();
}

function addEmployeeEntry(emp) {
    const container = document.getElementById('employee-entries');

    const entryDiv = document.createElement('div');
    entryDiv.className = 'employee-entry';
    entryDiv.id = `entry-${emp.id}`;
    entryDiv.dataset.employeeId = emp.id;

    let tipFields = '';
    emp.position.tip_requirements.forEach(req => {
        if (req.field_name !== 'no_tips') {
            if (req.field_name === 'calculated_take_home') {
                tipFields += `
                    <div class="form-group">
                        <label>${req.name}</label>
                        <input type="number" step="0.01" readonly value="0.00" class="calculated-field">
                    </div>
                `;
            } else {
                tipFields += `
                    <div class="form-group">
                        <label>${req.name}</label>
                        <input type="number" step="0.01" name="${req.field_name}_${emp.id}" value="0.00">
                    </div>
                `;
            }
        }
    });

    entryDiv.innerHTML = `
        <div class="employee-entry-header">
            <h4>${emp.name} - ${emp.position.name}</h4>
            <button type="button" class="btn-icon btn-remove" onclick="removeEmployee(${emp.id})" title="Remove employee">
                <span class="icon">−</span>
            </button>
        </div>
        <input type="hidden" name="employee_ids" value="${emp.id}" class="employee-id-input">
        <div class="form-row">
            ${tipFields}
            <div class="form-group">
                <label>Adjustments</label>
                <input type="number" step="0.01" name="adjustments_${emp.id}" value="0.00">
            </div>
        </div>
    `;

    container.appendChild(entryDiv);
}

function removeEmployee(employeeId) {
    if (confirm('Remove this employee from today\'s entries?')) {
        const entry = document.getElementById(`entry-${employeeId}`);
        if (entry) {
            entry.remove();
        }
    }
}

function calculateFinancialTotals() {
    const table1Fields = document.querySelectorAll('.table1-field');
    let table1Total = 0;

    table1Fields.forEach(field => {
        const value = parseFloat(field.value) || 0;
        table1Total += value;
    });

    document.getElementById('table1_total').value = table1Total.toFixed(2);

    const table2Fields = document.querySelectorAll('.table2-field');
    let table2Total = 0;

    table2Fields.forEach(field => {
        const value = parseFloat(field.value) || 0;
        table2Total += value;
    });

    document.getElementById('table2_total').value = table2Total.toFixed(2);

    const cashOverUnder = table1Total - table2Total;
    const cashOverUnderField = document.getElementById('cash_over_under');
    cashOverUnderField.value = cashOverUnder.toFixed(2);

    if (cashOverUnder > 0) {
        cashOverUnderField.style.color = '#059669';
    } else if (cashOverUnder < 0) {
        cashOverUnderField.style.color = '#dc2626';
    } else {
        cashOverUnderField.style.color = '#000';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    updateAddEmployeeDropdown();

    document.querySelectorAll('.table1-field, .table2-field').forEach(field => {
        field.addEventListener('input', calculateFinancialTotals);
    });

    calculateFinancialTotals();
});
</script>
{% endblock %}
