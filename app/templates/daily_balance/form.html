{% extends "base.html" %}

{% block title %}Daily Balance - {{ target_date }} - Management System{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Daily Balance</h2>
    <form method="GET" action="/daily-balance" style="display: inline-block;">
        <input type="date" name="selected_date" value="{{ target_date }}" onchange="this.form.submit()">
    </form>
</div>

<div class="daily-info">
    <h3>{{ target_date }} - {{ day_of_week }}</h3>
    {% if daily_balance and daily_balance.finalized %}
        {% if edit_mode %}
        <span class="badge badge-warning">Editing Finalized Report</span>
        {% else %}
        <span class="badge badge-success">Viewing Finalized Report</span>
        {% endif %}
    {% endif %}
</div>

{% if daily_balance and daily_balance.finalized and not edit_mode %}
<div class="view-mode-banner">
    <div class="banner-content">
        <span class="icon">üëÅÔ∏è</span>
        <span>You are viewing a finalized report in read-only mode.</span>
        <a href="/reports/daily-balance" class="btn btn-secondary btn-sm">Back to Reports</a>
    </div>
</div>
{% endif %}

{% if edit_mode %}
<div class="alert alert-warning">
    <strong>‚ö†Ô∏è Warning:</strong> You are editing a finalized report. Changes will overwrite the existing database entry and CSV file when saved.
</div>
{% endif %}

<form method="POST" action="{% if daily_balance and daily_balance.finalized %}/daily-balance/save{% else %}/daily-balance/save{% endif %}" id="dailyBalanceForm">
    <input type="hidden" name="target_date" value="{{ target_date }}">

    <div class="form-section">
        <h3>Daily Financial Summary</h3>

        <div class="financial-tables-container">
            <div class="financial-table">
                <div class="section-header">
                    <h4>Revenue & Income</h4>
                    {% if current_user.is_admin and not (daily_balance and daily_balance.finalized and not edit_mode) %}
                    <button type="button" class="btn btn-sm" id="manage-revenue-btn" onclick="toggleManagementMode('revenue')">
                        <span class="icon">‚öô</span> <span id="manage-revenue-text">Manage Items</span>
                    </button>
                    {% endif %}
                </div>
                <table class="summary-table" id="revenue-table">
                    <tbody>
                        {% for template in financial_templates %}
                            {% if template.category == 'revenue' %}
                        <tr data-template-id="{{ template.id }}" data-template-name="{{ template.name }}" data-is-deduction="{{ template.is_deduction|lower }}">
                            <td>
                                <span class="item-name-display" id="name-display-{{ template.id }}">
                                    {{ template.name }}
                                    {% if template.is_deduction %}
                                    <span style="color: #dc2626; font-weight: bold;" title="This item subtracts from the total"> (‚àí)</span>
                                    {% endif %}
                                </span>
                                <input type="text" class="item-name-edit" id="name-edit-{{ template.id }}" value="{{ template.name }}" style="display: none;">
                                {% if current_user.is_admin %}
                                <span class="item-management-controls" style="display: none;">
                                    <button type="button" class="btn-icon btn-edit-small" onclick="startEditItemName({{ template.id }})" id="edit-btn-{{ template.id }}" title="Rename item">
                                        <span class="icon">‚úé</span>
                                    </button>
                                    <button type="button" class="btn-icon btn-save-small" onclick="saveItemName({{ template.id }}, 'revenue')" id="save-btn-{{ template.id }}" style="display: none;" title="Save">
                                        <span class="icon">‚úì</span>
                                    </button>
                                    <button type="button" class="btn-icon btn-cancel-small" onclick="cancelEditItemName({{ template.id }})" id="cancel-btn-{{ template.id }}" style="display: none;" title="Cancel">
                                        <span class="icon">‚úó</span>
                                    </button>
                                    <button type="button" class="btn-icon btn-remove-small" onclick="deleteFinancialTemplate({{ template.id }}, 'revenue')" title="Remove item">
                                        <span class="icon">√ó</span>
                                    </button>
                                    <label style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;">
                                        <input type="checkbox" onchange="toggleDeduction({{ template.id }}, 'revenue', this.checked)" {% if template.is_deduction %}checked{% endif %} title="Mark as deduction">
                                        <span style="font-size: 12px;">Deduction</span>
                                    </label>
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <input type="number" step="0.01"
                                       name="financial_item_{{ template.id }}"
                                       class="table1-field"
                                       value="{% if financial_line_items.get('revenue_' + template.id|string) %}{{ financial_line_items.get('revenue_' + template.id|string).value }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                            {% endif %}
                        {% endfor %}
                        {% if daily_balance %}
                            {% for item in daily_balance.financial_line_items %}
                                {% if item.is_employee_tip and item.category == 'revenue' %}
                        <tr data-employee-tip="{{ item.employee_id }}" class="employee-tip-row">
                            <td><label>{{ item.name }}</label></td>
                            <td>
                                <input type="number" step="0.01" readonly
                                       class="table1-field calculated-field"
                                       value="{{ item.value }}">
                            </td>
                        </tr>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        <tr class="total-row">
                            <td><strong>Total</strong></td>
                            <td>
                                <input type="number" step="0.01" id="table1_total" readonly class="total-field" value="0.00">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="financial-table">
                <div class="section-header">
                    <h4>Deposits & Expenses</h4>
                    {% if current_user.is_admin and not (daily_balance and daily_balance.finalized and not edit_mode) %}
                    <button type="button" class="btn btn-sm" id="manage-expense-btn" onclick="toggleManagementMode('expense')">
                        <span class="icon">‚öô</span> <span id="manage-expense-text">Manage Items</span>
                    </button>
                    {% endif %}
                </div>
                <table class="summary-table" id="expense-table">
                    <tbody>
                        {% for template in financial_templates %}
                            {% if template.category == 'expense' %}
                        <tr data-template-id="{{ template.id }}" data-template-name="{{ template.name }}" data-is-deduction="{{ template.is_deduction|lower }}">
                            <td>
                                <span class="item-name-display" id="name-display-{{ template.id }}">
                                    {{ template.name }}
                                    {% if template.is_deduction %}
                                    <span style="color: #dc2626; font-weight: bold;" title="This item subtracts from the total"> (‚àí)</span>
                                    {% endif %}
                                </span>
                                <input type="text" class="item-name-edit" id="name-edit-{{ template.id }}" value="{{ template.name }}" style="display: none;">
                                {% if current_user.is_admin %}
                                <span class="item-management-controls" style="display: none;">
                                    <button type="button" class="btn-icon btn-edit-small" onclick="startEditItemName({{ template.id }})" id="edit-btn-{{ template.id }}" title="Rename item">
                                        <span class="icon">‚úé</span>
                                    </button>
                                    <button type="button" class="btn-icon btn-save-small" onclick="saveItemName({{ template.id }}, 'expense')" id="save-btn-{{ template.id }}" style="display: none;" title="Save">
                                        <span class="icon">‚úì</span>
                                    </button>
                                    <button type="button" class="btn-icon btn-cancel-small" onclick="cancelEditItemName({{ template.id }})" id="cancel-btn-{{ template.id }}" style="display: none;" title="Cancel">
                                        <span class="icon">‚úó</span>
                                    </button>
                                    <button type="button" class="btn-icon btn-remove-small" onclick="deleteFinancialTemplate({{ template.id }}, 'expense')" title="Remove item">
                                        <span class="icon">√ó</span>
                                    </button>
                                    <label style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;">
                                        <input type="checkbox" onchange="toggleDeduction({{ template.id }}, 'expense', this.checked)" {% if template.is_deduction %}checked{% endif %} title="Mark as deduction">
                                        <span style="font-size: 12px;">Deduction</span>
                                    </label>
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <input type="number" step="0.01"
                                       name="financial_item_{{ template.id }}"
                                       class="table2-field"
                                       value="{% if financial_line_items.get('expense_' + template.id|string) %}{{ financial_line_items.get('expense_' + template.id|string).value }}{% else %}0.00{% endif %}"
                                       {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            </td>
                        </tr>
                            {% endif %}
                        {% endfor %}
                        <tr class="total-row">
                            <td><strong>Total</strong></td>
                            <td>
                                <input type="number" step="0.01" id="table2_total" readonly class="total-field" value="0.00">
                            </td>
                        </tr>
                        <tr class="highlight-row">
                            <td><strong>Cash Over/Under</strong></td>
                            <td>
                                <input type="number" step="0.01" id="cash_over_under" readonly class="total-field highlight-field" value="0.00">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="notes">Notes</label>
            <textarea id="notes" name="notes" rows="3"
                      {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>{% if daily_balance %}{{ daily_balance.notes }}{% endif %}</textarea>
        </div>
    </div>

    {% if current_user.is_admin %}
    <div id="manage-items-modal" class="add-employee-modal" style="display: none;">
        <div class="modal-content-inline">
            <h4 id="manage-items-title">Manage Financial Items</h4>
            <div class="form-group">
                <label for="new-item-name">Item Name</label>
                <input type="text" id="new-item-name" placeholder="e.g., Liquor Sales" class="form-control">
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="new-item-is-deduction">
                    <span>Mark as deduction (subtracts from total)</span>
                </label>
            </div>
            <button type="button" class="btn btn-primary btn-sm" onclick="addFinancialTemplate()">Add Item</button>
            <button type="button" class="btn btn-secondary btn-sm" onclick="closeManageModal()">Close</button>
        </div>
    </div>
    {% endif %}

    <div class="form-section">
        <div class="section-header">
            <h3>Employee Entries</h3>
            {% if not (daily_balance and daily_balance.finalized and not edit_mode) %}
            <button type="button" class="btn btn-sm" onclick="toggleAddEmployeeModal()">
                <span class="icon">+</span> Add Employee
            </button>
            {% endif %}
        </div>

        {% if not (daily_balance and daily_balance.finalized and not edit_mode) %}
        <div id="add-employee-modal" class="add-employee-modal" style="display: none;">
            <div class="modal-content-inline">
                <h4>Add Employee</h4>
                <select id="employee-to-add" class="employee-add-select">
                    <option value="">Select an employee...</option>
                </select>
                <button type="button" class="btn btn-primary btn-sm" onclick="addSelectedEmployee()">Add</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleAddEmployeeModal()">Cancel</button>
            </div>
        </div>
        {% endif %}

        <div id="employee-entries">
            {% for emp in working_employees %}
            <div class="employee-entry" id="entry-{{ emp.id }}" data-employee-id="{{ emp.id }}">
                <div class="employee-entry-header">
                    <h4>{{ emp.name }} - {{ emp.position.name }}</h4>
                    {% if not (daily_balance and daily_balance.finalized and not edit_mode) %}
                    <button type="button" class="btn-icon btn-remove" onclick="removeEmployee({{ emp.id }})" title="Remove employee">
                        <span class="icon">‚àí</span>
                    </button>
                    {% endif %}
                </div>
                <input type="hidden" name="employee_ids" value="{{ emp.id }}" class="employee-id-input">

                <div class="form-row">
                    {% for req in emp.position.tip_requirements %}
                        {% if req.field_name != 'no_tips' %}
                        <div class="form-group">
                            <label>{{ req.name }}</label>
                            {% if req.field_name == 'calculated_take_home' %}
                            <input type="number" step="0.01" readonly
                                   value="{% if employee_entries.get(emp.id) %}{{ employee_entries.get(emp.id).calculated_take_home }}{% else %}0.00{% endif %}"
                                   class="calculated-field calculated-take-home"
                                   data-employee-id="{{ emp.id }}">
                            {% else %}
                            <input type="number" step="0.01" name="{{ req.field_name }}_{{ emp.id }}"
                                   class="tip-input{% if req.field_name in ['bank_card_tips', 'cash_tips', 'adjustments', 'tips_on_paycheck', 'tip_out'] %}" data-tip-field="{{ req.field_name }}{% endif %}"
                                   data-employee-id="{{ emp.id }}"
                                   value="{% if employee_entries.get(emp.id) %}{{ employee_entries.get(emp.id)[req.field_name] }}{% else %}0.00{% endif %}"
                                   {% if daily_balance and daily_balance.finalized and not edit_mode %}readonly{% endif %}>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    {% if not (daily_balance and daily_balance.finalized and not edit_mode) %}
    <div class="form-actions">
        <button type="submit" class="btn btn-secondary" formaction="/daily-balance/save">Save Draft</button>
        <button type="button" class="btn btn-primary" onclick="openFinalizeModal()">
            Generate Report (Finalize)
        </button>
    </div>
    {% endif %}
</form>

<div id="finalize-modal" class="modal">
    <div class="modal-content">
        <h3>Finalize Daily Balance Report</h3>
        <p>You are about to finalize the daily balance report for {{ target_date }}. A CSV report will be generated.</p>

        <div class="form-group">
            <label>
                <input type="checkbox" id="finalize_send_email" onchange="toggleFinalizeEmailSection()">
                <strong>Send report via email</strong>
            </label>
        </div>

        <div id="finalize-email-section" style="display: none;">
            <div class="email-recipients-section">
                <h4>Email Recipients</h4>
                <div id="finalize-admin-users-list" class="users-list">
                </div>
            </div>

            <div class="form-group" style="margin-top: 1rem;">
                <label>
                    <input type="checkbox" id="finalize_additional_email_checkbox" onchange="toggleFinalizeAdditionalEmail()">
                    Send to additional email address
                </label>
            </div>

            <div id="finalize_additional_email_container" style="display: none; margin-top: 0.5rem;">
                <input type="email"
                       id="finalize_additional_email_input"
                       placeholder="email@example.com"
                       class="form-control">
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeFinalizeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitFinalize()">Finalize Report</button>
        </div>
    </div>
</div>

<script>
const allEmployees = {{ all_employees | tojson }};
const workingEmployeeIds = new Set({{ working_employee_ids | tojson }});

function updateAddEmployeeDropdown() {
    const select = document.getElementById('employee-to-add');
    if (!select) {
        console.log('Employee dropdown not found (likely in read-only mode)');
        return;
    }

    const currentEmployeeIds = new Set();

    document.querySelectorAll('.employee-id-input').forEach(input => {
        currentEmployeeIds.add(parseInt(input.value));
    });

    select.innerHTML = '<option value="">Select an employee...</option>';

    allEmployees.forEach(emp => {
        if (!currentEmployeeIds.has(emp.id)) {
            const option = document.createElement('option');
            option.value = emp.id;
            option.textContent = `${emp.name} (${emp.position.name})`;
            option.dataset.employee = JSON.stringify(emp);
            select.appendChild(option);
        }
    });
}

function toggleAddEmployeeModal() {
    const modal = document.getElementById('add-employee-modal');
    if (modal.style.display === 'none') {
        updateAddEmployeeDropdown();
        modal.style.display = 'block';
    } else {
        modal.style.display = 'none';
    }
}

function addSelectedEmployee() {
    const select = document.getElementById('employee-to-add');
    const selectedOption = select.options[select.selectedIndex];

    if (!selectedOption.value) {
        alert('Please select an employee');
        return;
    }

    const employee = JSON.parse(selectedOption.dataset.employee);
    addEmployeeEntry(employee);
    toggleAddEmployeeModal();
}

function addEmployeeEntry(emp) {
    const container = document.getElementById('employee-entries');

    const entryDiv = document.createElement('div');
    entryDiv.className = 'employee-entry';
    entryDiv.id = `entry-${emp.id}`;
    entryDiv.dataset.employeeId = emp.id;

    let tipFields = '';
    emp.position.tip_requirements.forEach(req => {
        if (req.field_name !== 'no_tips') {
            if (req.field_name === 'calculated_take_home') {
                tipFields += `
                    <div class="form-group">
                        <label>${req.name}</label>
                        <input type="number" step="0.01" readonly value="0.00"
                               class="calculated-field calculated-take-home"
                               data-employee-id="${emp.id}">
                    </div>
                `;
            } else {
                const tipFieldClass = ['bank_card_tips', 'cash_tips', 'adjustments', 'tips_on_paycheck', 'tip_out'].includes(req.field_name) ?
                    `tip-input" data-tip-field="${req.field_name}` : 'tip-input';
                tipFields += `
                    <div class="form-group">
                        <label>${req.name}</label>
                        <input type="number" step="0.01"
                               name="${req.field_name}_${emp.id}"
                               class="${tipFieldClass}"
                               data-employee-id="${emp.id}"
                               value="0.00">
                    </div>
                `;
            }
        }
    });

    entryDiv.innerHTML = `
        <div class="employee-entry-header">
            <h4>${emp.name} - ${emp.position.name}</h4>
            <button type="button" class="btn-icon btn-remove" onclick="removeEmployee(${emp.id})" title="Remove employee">
                <span class="icon">‚àí</span>
            </button>
        </div>
        <input type="hidden" name="employee_ids" value="${emp.id}" class="employee-id-input">
        <div class="form-row">
            ${tipFields}
        </div>
    `;

    container.appendChild(entryDiv);

    attachEmployeeInputListeners(entryDiv);
    calculateEmployeeTakeHome(emp.id);
    updateEmployeeTipsInRevenue();
}

function removeEmployee(employeeId) {
    if (confirm('Remove this employee from today\'s entries?')) {
        const entry = document.getElementById(`entry-${employeeId}`);
        if (entry) {
            entry.remove();
            updateEmployeeTipsInRevenue();
            calculateFinancialTotals();
        }
    }
}

function calculateEmployeeTakeHome(employeeId) {
    const bankCardTipsInput = document.querySelector(`input[name="bank_card_tips_${employeeId}"]`);
    const cashTipsInput = document.querySelector(`input[name="cash_tips_${employeeId}"]`);
    const adjustmentsInput = document.querySelector(`input[name="adjustments_${employeeId}"]`);
    const tipsOnPaycheckInput = document.querySelector(`input[name="tips_on_paycheck_${employeeId}"]`);
    const tipOutInput = document.querySelector(`input[name="tip_out_${employeeId}"]`);
    const takeHomeInput = document.querySelector(`.calculated-take-home[data-employee-id="${employeeId}"]`);

    if (!takeHomeInput) return;

    const bankCardTips = parseFloat(bankCardTipsInput?.value || 0);
    const cashTips = parseFloat(cashTipsInput?.value || 0);
    const adjustments = parseFloat(adjustmentsInput?.value || 0);
    const tipsOnPaycheck = parseFloat(tipsOnPaycheckInput?.value || 0);
    const tipOut = parseFloat(tipOutInput?.value || 0);

    const takeHome = bankCardTips + cashTips + adjustments - tipsOnPaycheck - tipOut;
    takeHomeInput.value = takeHome.toFixed(2);
}

function updateEmployeeTipsInRevenue() {
    const revenueTable = document.querySelector('#revenue-table tbody');
    const existingTipRows = revenueTable.querySelectorAll('.employee-tip-row');
    existingTipRows.forEach(row => row.remove());

    const employeeEntries = document.querySelectorAll('.employee-entry');
    let insertBeforeRow = revenueTable.querySelector('.total-row');

    employeeEntries.forEach(entry => {
        const employeeId = entry.dataset.employeeId;
        const tipsOnPaycheckInput = entry.querySelector(`input[name="tips_on_paycheck_${employeeId}"]`);
        const tipsValue = parseFloat(tipsOnPaycheckInput?.value || 0);

        if (tipsValue > 0) {
            const employeeName = entry.querySelector('.employee-entry-header h4').textContent.split(' - ')[0];

            const newRow = document.createElement('tr');
            newRow.className = 'employee-tip-row';
            newRow.dataset.employeeTip = employeeId;
            newRow.innerHTML = `
                <td><label>${employeeName} - Tips on Paycheck</label></td>
                <td>
                    <input type="number" step="0.01" readonly class="table1-field calculated-field" value="${tipsValue.toFixed(2)}">
                </td>
            `;

            revenueTable.insertBefore(newRow, insertBeforeRow);
        }
    });

    calculateFinancialTotals();
}

function attachEmployeeInputListeners(container) {
    const inputs = container.querySelectorAll('.tip-input');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            const employeeId = this.dataset.employeeId;
            calculateEmployeeTakeHome(employeeId);

            if (this.dataset.tipField === 'tips_on_paycheck') {
                updateEmployeeTipsInRevenue();
            }
        });
    });
}

function calculateFinancialTotals() {
    console.log('=== calculateFinancialTotals called ===');
    const table1Rows = document.querySelectorAll('#revenue-table tbody tr:not(.total-row)');
    console.log('Revenue rows found:', table1Rows.length);
    let table1Total = 0;

    table1Rows.forEach((row, index) => {
        const field = row.querySelector('.table1-field');
        console.log(`Row ${index}:`, field ? `value=${field.value}, isDeduction=${row.dataset.isDeduction}` : 'NO FIELD FOUND');
        if (field) {
            const value = parseFloat(field.value) || 0;
            const isDeduction = row.dataset.isDeduction === 'true';
            if (isDeduction) {
                table1Total -= value;
            } else {
                table1Total += value;
            }
        }
    });

    console.log('Revenue total calculated:', table1Total);
    document.getElementById('table1_total').value = table1Total.toFixed(2);

    const table2Rows = document.querySelectorAll('#expense-table tbody tr:not(.total-row):not(.highlight-row)');
    console.log('Expense rows found:', table2Rows.length);
    let table2Total = 0;

    table2Rows.forEach((row, index) => {
        const field = row.querySelector('.table2-field');
        console.log(`Expense row ${index}:`, field ? `value=${field.value}, isDeduction=${row.dataset.isDeduction}` : 'NO FIELD FOUND');
        if (field) {
            const value = parseFloat(field.value) || 0;
            const isDeduction = row.dataset.isDeduction === 'true';
            if (isDeduction) {
                table2Total -= value;
            } else {
                table2Total += value;
            }
        }
    });

    console.log('Expense total calculated:', table2Total);
    document.getElementById('table2_total').value = table2Total.toFixed(2);

    const cashOverUnder = table2Total - table1Total;
    const cashOverUnderField = document.getElementById('cash_over_under');
    cashOverUnderField.value = cashOverUnder.toFixed(2);

    if (cashOverUnder > 0) {
        cashOverUnderField.style.color = '#059669';
    } else if (cashOverUnder < 0) {
        cashOverUnderField.style.color = '#dc2626';
    } else {
        cashOverUnderField.style.color = '#000';
    }
}

let currentManageCategory = 'revenue';
let isManagementModeActive = {
    revenue: false,
    expense: false
};

function toggleManagementMode(category) {
    const isActive = isManagementModeActive[category];
    const buttonTextElement = document.getElementById(`manage-${category}-text`);
    const modal = document.getElementById('manage-items-modal');
    const title = document.getElementById('manage-items-title');

    const tableId = category === 'revenue' ? 'revenue-table' : 'expense-table';
    const controls = document.querySelectorAll(`#${tableId} .item-management-controls`);

    if (!isActive) {
        controls.forEach(control => control.style.display = 'inline');
        buttonTextElement.textContent = 'Add New Item';
        isManagementModeActive[category] = true;

        currentManageCategory = category;
        title.textContent = category === 'revenue' ? 'Add Revenue & Income Item' : 'Add Deposits & Expenses Item';
        document.getElementById('new-item-name').value = '';
        modal.style.display = 'block';
    } else {
        controls.forEach(control => control.style.display = 'none');
        buttonTextElement.textContent = 'Manage Items';
        isManagementModeActive[category] = false;
        modal.style.display = 'none';
    }
}

function closeManageModal() {
    const modal = document.getElementById('manage-items-modal');
    modal.style.display = 'none';
}

async function addFinancialTemplate() {
    const nameInput = document.getElementById('new-item-name');
    const isDeductionInput = document.getElementById('new-item-is-deduction');
    const name = nameInput.value.trim();
    const isDeduction = isDeductionInput.checked;

    if (!name) {
        alert('Please enter an item name');
        return;
    }

    try {
        const response = await fetch('/api/financial-items/templates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                category: currentManageCategory,
                is_deduction: isDeduction
            })
        });

        if (!response.ok) {
            throw new Error('Failed to add item');
        }

        const newTemplate = await response.json();

        const tableId = currentManageCategory === 'revenue' ? 'revenue-table' : 'expense-table';
        const fieldClass = currentManageCategory === 'revenue' ? 'table1-field' : 'table2-field';
        const table = document.querySelector(`#${tableId} tbody`);
        const totalRow = table.querySelector('.total-row');

        const newRow = document.createElement('tr');
        newRow.dataset.templateId = newTemplate.id;
        newRow.dataset.templateName = newTemplate.name;
        newRow.dataset.isDeduction = newTemplate.is_deduction;
        newRow.innerHTML = `
            <td>
                <span class="item-name-display" id="name-display-${newTemplate.id}">
                    ${newTemplate.name}
                    ${newTemplate.is_deduction ? '<span style="color: #dc2626; font-weight: bold;" title="This item subtracts from the total"> (‚àí)</span>' : ''}
                </span>
                <input type="text" class="item-name-edit" id="name-edit-${newTemplate.id}" value="${newTemplate.name}" style="display: none;">
                <span class="item-management-controls" style="display: ${isManagementModeActive[currentManageCategory] ? 'inline' : 'none'};">
                    <button type="button" class="btn-icon btn-edit-small" onclick="startEditItemName(${newTemplate.id})" id="edit-btn-${newTemplate.id}" title="Rename item">
                        <span class="icon">‚úé</span>
                    </button>
                    <button type="button" class="btn-icon btn-save-small" onclick="saveItemName(${newTemplate.id}, '${currentManageCategory}')" id="save-btn-${newTemplate.id}" style="display: none;" title="Save">
                        <span class="icon">‚úì</span>
                    </button>
                    <button type="button" class="btn-icon btn-cancel-small" onclick="cancelEditItemName(${newTemplate.id})" id="cancel-btn-${newTemplate.id}" style="display: none;" title="Cancel">
                        <span class="icon">‚úó</span>
                    </button>
                    <button type="button" class="btn-icon btn-remove-small" onclick="deleteFinancialTemplate(${newTemplate.id}, '${currentManageCategory}')" title="Remove item">
                        <span class="icon">√ó</span>
                    </button>
                    <label style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;">
                        <input type="checkbox" onchange="toggleDeduction(${newTemplate.id}, '${currentManageCategory}', this.checked)" ${newTemplate.is_deduction ? 'checked' : ''} title="Mark as deduction">
                        <span style="font-size: 12px;">Deduction</span>
                    </label>
                </span>
            </td>
            <td>
                <input type="number" step="0.01"
                       name="financial_item_${newTemplate.id}"
                       class="${fieldClass}"
                       value="0.00">
            </td>
        `;

        table.insertBefore(newRow, totalRow);

        const inputField = newRow.querySelector(`.${fieldClass}`);
        inputField.addEventListener('input', calculateFinancialTotals);

        nameInput.value = '';
        isDeductionInput.checked = false;
        calculateFinancialTotals();

        alert('Item added successfully! It will appear on all future days.');

    } catch (error) {
        console.error('Error adding financial template:', error);
        alert('Failed to add item. Please try again.');
    }
}

function startEditItemName(templateId) {
    const display = document.getElementById(`name-display-${templateId}`);
    const edit = document.getElementById(`name-edit-${templateId}`);
    const editBtn = document.getElementById(`edit-btn-${templateId}`);
    const saveBtn = document.getElementById(`save-btn-${templateId}`);
    const cancelBtn = document.getElementById(`cancel-btn-${templateId}`);

    display.style.display = 'none';
    edit.style.display = 'inline-block';
    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';

    edit.focus();
    edit.select();
}

function cancelEditItemName(templateId) {
    const display = document.getElementById(`name-display-${templateId}`);
    const edit = document.getElementById(`name-edit-${templateId}`);
    const editBtn = document.getElementById(`edit-btn-${templateId}`);
    const saveBtn = document.getElementById(`save-btn-${templateId}`);
    const cancelBtn = document.getElementById(`cancel-btn-${templateId}`);

    const row = document.querySelector(`tr[data-template-id="${templateId}"]`);
    edit.value = row.dataset.templateName;

    display.style.display = 'inline';
    edit.style.display = 'none';
    editBtn.style.display = 'inline-block';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
}

async function saveItemName(templateId, category) {
    const edit = document.getElementById(`name-edit-${templateId}`);
    const newName = edit.value.trim();

    if (!newName) {
        alert('Item name cannot be empty');
        return;
    }

    try {
        const response = await fetch(`/api/financial-items/templates/${templateId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: newName
            })
        });

        if (!response.ok) {
            throw new Error('Failed to update item name');
        }

        const display = document.getElementById(`name-display-${templateId}`);
        const editBtn = document.getElementById(`edit-btn-${templateId}`);
        const saveBtn = document.getElementById(`save-btn-${templateId}`);
        const cancelBtn = document.getElementById(`cancel-btn-${templateId}`);
        const row = document.querySelector(`tr[data-template-id="${templateId}"]`);

        display.textContent = newName;
        row.dataset.templateName = newName;

        display.style.display = 'inline';
        edit.style.display = 'none';
        editBtn.style.display = 'inline-block';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';

    } catch (error) {
        console.error('Error updating item name:', error);
        alert('Failed to update item name. Please try again.');
    }
}

async function deleteFinancialTemplate(templateId, category) {
    if (!confirm('Are you sure you want to remove this item? It will be removed from all future days (existing data will not be affected).')) {
        return;
    }

    try {
        const response = await fetch(`/api/financial-items/templates/${templateId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.detail || 'Failed to delete item');
        }

        const tableId = category === 'revenue' ? 'revenue-table' : 'expense-table';
        const row = document.querySelector(`#${tableId} tr[data-template-id="${templateId}"]`);
        if (row) {
            row.remove();
            calculateFinancialTotals();
        }

    } catch (error) {
        console.error('Error deleting financial template:', error);
        alert(error.message || 'Failed to delete item. Please try again.');
    }
}

async function toggleDeduction(templateId, category, isDeduction) {
    const tableId = category === 'revenue' ? 'revenue-table' : 'expense-table';
    const row = document.querySelector(`#${tableId} tr[data-template-id="${templateId}"]`);
    const templateName = row.dataset.templateName;

    try {
        const response = await fetch(`/api/financial-items/templates/${templateId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: templateName,
                is_deduction: isDeduction
            })
        });

        if (!response.ok) {
            throw new Error('Failed to update deduction status');
        }

        row.dataset.isDeduction = isDeduction;

        const nameDisplay = row.querySelector(`#name-display-${templateId}`);
        const existingDeductionIndicator = nameDisplay.querySelector('span[title="This item subtracts from the total"]');

        if (isDeduction && !existingDeductionIndicator) {
            const indicator = document.createElement('span');
            indicator.style.color = '#dc2626';
            indicator.style.fontWeight = 'bold';
            indicator.title = 'This item subtracts from the total';
            indicator.textContent = ' (‚àí)';
            nameDisplay.appendChild(indicator);
        } else if (!isDeduction && existingDeductionIndicator) {
            existingDeductionIndicator.remove();
        }

        calculateFinancialTotals();

    } catch (error) {
        console.error('Error toggling deduction:', error);
        alert('Failed to update deduction status. Please try again.');
        const checkbox = row.querySelector('input[type="checkbox"]');
        if (checkbox) {
            checkbox.checked = !isDeduction;
        }
    }
}

let finalizeAdminUsers = [];

async function loadFinalizeAdminUsers() {
    try {
        const response = await fetch('/reports/api/admin-users?report_type=daily');
        const result = await response.json();
        if (result.success) {
            finalizeAdminUsers = result.users;
            renderFinalizeUserList();
        }
    } catch (error) {
        console.error('Failed to load admin users:', error);
    }
}

function renderFinalizeUserList() {
    const container = document.getElementById('finalize-admin-users-list');
    if (!container) return;

    if (finalizeAdminUsers.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic;">No admin users with emails found.</p>';
        return;
    }

    let html = '';
    finalizeAdminUsers.forEach(user => {
        html += `
            <label class="user-checkbox-label">
                <input type="checkbox"
                       name="finalize_user_email"
                       value="${user.email}"
                       data-user-id="${user.id}"
                       ${user.opt_in ? 'checked' : ''}>
                <span>${user.username} (${user.email})</span>
            </label>
        `;
    });

    container.innerHTML = html;
}

function openFinalizeModal() {
    loadFinalizeAdminUsers();
    const modal = document.getElementById('finalize-modal');
    modal.classList.add('active');
}

function closeFinalizeModal() {
    const modal = document.getElementById('finalize-modal');
    modal.classList.remove('active');
    document.getElementById('finalize_send_email').checked = false;
    document.getElementById('finalize-email-section').style.display = 'none';
}

function toggleFinalizeEmailSection() {
    const checkbox = document.getElementById('finalize_send_email');
    const section = document.getElementById('finalize-email-section');
    section.style.display = checkbox.checked ? 'block' : 'none';
}

function toggleFinalizeAdditionalEmail() {
    const checkbox = document.getElementById('finalize_additional_email_checkbox');
    const container = document.getElementById('finalize_additional_email_container');
    if (checkbox.checked) {
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
        document.getElementById('finalize_additional_email_input').value = '';
    }
}

async function submitFinalize() {
    const form = document.getElementById('dailyBalanceForm');
    const formData = new FormData(form);
    const targetDate = formData.get('target_date');

    const sendEmail = document.getElementById('finalize_send_email').checked;

    try {
        const response = await fetch('/daily-balance/finalize', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            if (sendEmail) {
                const selectedEmails = [];
                const checkboxes = document.querySelectorAll('input[name="finalize_user_email"]:checked');
                checkboxes.forEach(cb => selectedEmails.push(cb.value));

                const additionalEmailCheckbox = document.getElementById('finalize_additional_email_checkbox');
                const additionalEmailInput = document.getElementById('finalize_additional_email_input');

                if (additionalEmailCheckbox && additionalEmailCheckbox.checked) {
                    const additionalEmail = additionalEmailInput.value.trim();
                    if (additionalEmail) {
                        selectedEmails.push(additionalEmail);
                    }
                }

                if (selectedEmails.length > 0) {
                    const emailFormData = new FormData();
                    selectedEmails.forEach(email => emailFormData.append('user_emails[]', email));
                    emailFormData.append('start_date', targetDate);
                    emailFormData.append('end_date', targetDate);

                    await fetch('/reports/daily-balance/email', {
                        method: 'POST',
                        body: emailFormData
                    });
                }
            }

            window.location.href = `/daily-balance?selected_date=${targetDate}`;
        } else {
            alert('Failed to finalize report. Please try again.');
        }
    } catch (error) {
        console.error('Error finalizing report:', error);
        alert('An error occurred. Please try again.');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== Page loaded, initializing ===');
    updateAddEmployeeDropdown();

    document.querySelectorAll('.table1-field, .table2-field').forEach(field => {
        field.addEventListener('input', calculateFinancialTotals);
    });

    document.querySelectorAll('.employee-entry').forEach(entry => {
        attachEmployeeInputListeners(entry);
    });

    console.log('=== Calling calculateFinancialTotals on page load ===');
    calculateFinancialTotals();

    document.querySelectorAll('.employee-entry').forEach(entry => {
        const employeeId = entry.dataset.employeeId;
        calculateEmployeeTakeHome(employeeId);
    });
});
</script>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
}

.modal.active {
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    padding: 2rem;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-content h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: #2c3e50;
}

.modal-content h4 {
    margin-top: 0;
    margin-bottom: 0.5rem;
    font-size: 1rem;
    color: #2c3e50;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 2rem;
}

.email-recipients-section {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 4px;
    margin-top: 1rem;
}

.users-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.user-checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: white;
    border-radius: 4px;
    cursor: pointer;
}

.user-checkbox-label:hover {
    background: #e9ecef;
}

.user-checkbox-label input[type="checkbox"] {
    cursor: pointer;
}
</style>
{% endblock %}
